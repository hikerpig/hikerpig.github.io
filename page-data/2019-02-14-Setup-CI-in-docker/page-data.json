{"componentChunkName":"component---src-templates-page-js","path":"/2019-02-14-Setup-CI-in-docker/","result":{"data":{"site":{"siteMetadata":{"title":"HP goes FE","author":"@hikerpig"}},"markdownRemark":{"id":"c9e2799b-ebbc-5939-bfc1-1da5054afdc8","html":"<p>前注：在 docker 镜像中拉取 git 仓库似乎是一种 anti-pattern，本文只是记录中间的踩坑经历。</p>\n<p>托管在公司 gitlab 上的一个前端项目，最近在尝试 docker 化。</p>\n<h1 id=\"准备阶段\" style=\"position:relative;\"><a href=\"#%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5\" aria-label=\"准备阶段 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>准备阶段</h1>\n<h2 id=\"gitlab-上的一些问题\" style=\"position:relative;\"><a href=\"#gitlab-%E4%B8%8A%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98\" aria-label=\"gitlab 上的一些问题 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gitlab 上的一些问题</h2>\n<p>如果项目不是公开的，从 docker 环境中拉取代码会有些许权限问题，可一一解决。</p>\n<h3 id=\"clone-with-deploy-token\" style=\"position:relative;\"><a href=\"#clone-with-deploy-token\" aria-label=\"clone with deploy token permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>clone with deploy token</h3>\n<p>到 Gitlab 中对应项目的 settings/repository 页面，生成 Deploy Tokens, 便可以使用 https clone 项目，不用输入用户密码，也不必使用设置相对比较麻烦的 ssh deploy key 方式。</p>\n<p>克隆项目的命令为</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone https://<span class=\"token operator\">&lt;</span>name<span class=\"token operator\">></span>:<span class=\"token operator\">&lt;</span>token<span class=\"token operator\">></span>@gitlab.com/<span class=\"token operator\">&lt;</span><span class=\"token environment constant\">USER</span><span class=\"token operator\">></span>/<span class=\"token operator\">&lt;</span>REPO<span class=\"token operator\">></span>.git</code></pre></div>\n<p>此处的 <code>name</code> 是 token name, 不是用户名。只对此项目生效，避免使用权限较高的用户 token。</p>\n<h3 id=\"git-lfs-拉取文件出错\" style=\"position:relative;\"><a href=\"#git-lfs-%E6%8B%89%E5%8F%96%E6%96%87%E4%BB%B6%E5%87%BA%E9%94%99\" aria-label=\"git lfs 拉取文件出错 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>git-lfs 拉取文件出错</h3>\n<p>即便使用了 deploy token 可以克隆项目文件，但其中使用 git-lfs 追踪的一些文件会失败：</p>\n<div class=\"gatsby-highlight\" data-language=\"txt\"><pre class=\"language-txt\"><code class=\"language-txt\">Error downloading object: some/filename/blah: Smudge error: https://&lt;name&gt;:&lt;token&gt;@gitlab.com/some/repo.git/info/lfs/objects/batch</code></pre></div>\n<p>应该是权限问题，可以越过 git-lfs 的 smudge 步骤来规避此问题。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">GIT_LFS_SKIP_SMUDGE</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token function\">git</span> clone <span class=\"token operator\">&lt;</span>SERVER-REPOSITORY<span class=\"token operator\">></span></code></pre></div>\n<p>参考:  <a href=\"https://stackoverflow.com/questions/42019529/how-to-clone-pull-a-git-repository-ignoring-lfs\">https://stackoverflow.com/questions/42019529/how-to-clone-pull-a-git-repository-ignoring-lfs</a></p>\n<h1 id=\"开始\" style=\"position:relative;\"><a href=\"#%E5%BC%80%E5%A7%8B\" aria-label=\"开始 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>开始</h1>\n<h2 id=\"dockerfile\" style=\"position:relative;\"><a href=\"#dockerfile\" aria-label=\"dockerfile permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dockerfile</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">FROM node:8.15.0-slim\n\n# install git-lfs\nRUN curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh |  bash\nRUN apt-get install -y git-lfs\n\nWORKDIR /app\n\nRUN GIT_LFS_SKIP_SMUDGE=1 git clone https://&lt;name&gt;:&lt;token&gt;@gitlab.com/&lt;USER&gt;/&lt;REPO&gt;.git myrepo\n\nWORKDIR /app/myrepo\n\nRUN yarn</code></pre></div>\n<h2 id=\"构建镜像\" style=\"position:relative;\"><a href=\"#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F\" aria-label=\"构建镜像 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>构建镜像</h2>\n<p>在 Dockerfile 所在目录下:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker build -t my-app <span class=\"token builtin class-name\">.</span></code></pre></div>\n<p>等待几分钟，构建完成便可使用 <code>docker inspect my-app</code> 命令看看新添加的镜像。</p>\n<p>若 package.json 依赖较多，且可以接受在 docker host 和 vm 之间共享文件，可以去掉 <code>RUN yarn</code> 这一步，然后使用 <a href=\"https://docs.docker.com/storage/volumes/\">docker volume</a> 共享宿主环境中已经提前安装好的 node_modules 文件夹。</p>\n<h2 id=\"启动容器\" style=\"position:relative;\"><a href=\"#%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8\" aria-label=\"启动容器 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>启动容器</h2>\n<p>启动一个带 tty 的 interactive 容器并运行 bash，可以在容器里转一转，看看有什么东西:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker run -v /path/to/current/node_modules:/app/myrepo/node_modules -it my-app  --name app-tty /bin/bash</code></pre></div>\n<p>或是直接跑测试:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker run -v /path/to/current/node_modules:/app/myrepo/node_modules -it my-app  --name test-container /bin/bash -c <span class=\"token string\">'cd /app/myrepo &amp;&amp; npm run test'</span></code></pre></div>","excerpt":"前注：在 docker 镜像中拉取 git 仓库似乎是一种 anti-pattern，本文只是记录中间的踩坑经历。 托管在公司 gitlab 上的一个前端项目，最近在尝试 docker 化。 准备阶段 Gitlab 上的一些问题 如果项目不是公开的，从 docker…","tableOfContents":"<ul>\n<li>\n<p><a href=\"/2019-02-14-Setup-CI-in-docker/#%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5\">准备阶段</a></p>\n<ul>\n<li>\n<p><a href=\"/2019-02-14-Setup-CI-in-docker/#gitlab-%E4%B8%8A%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98\">Gitlab 上的一些问题</a></p>\n<ul>\n<li><a href=\"/2019-02-14-Setup-CI-in-docker/#clone-with-deploy-token\">clone with deploy token</a></li>\n<li><a href=\"/2019-02-14-Setup-CI-in-docker/#git-lfs-%E6%8B%89%E5%8F%96%E6%96%87%E4%BB%B6%E5%87%BA%E9%94%99\">git-lfs 拉取文件出错</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"/2019-02-14-Setup-CI-in-docker/#%E5%BC%80%E5%A7%8B\">开始</a></p>\n<ul>\n<li><a href=\"/2019-02-14-Setup-CI-in-docker/#dockerfile\">Dockerfile</a></li>\n<li><a href=\"/2019-02-14-Setup-CI-in-docker/#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F\">构建镜像</a></li>\n<li><a href=\"/2019-02-14-Setup-CI-in-docker/#%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8\">启动容器</a></li>\n</ul>\n</li>\n</ul>","fields":{"slug":"/2019-02-14-Setup-CI-in-docker/","featureImageSrc":null},"frontmatter":{"title":"在 docker 环境中从 gitlab 拉取源码","date":"2019-02-15","author":null,"tags":["docker","前端","git"],"use_toc":null,"coverImage":null}}},"pageContext":{"type":"posts","next":{"fields":{"slug":"/2019-03-08-Tips-On-Viewing-Logs/"},"frontmatter":{"title":"Tips On Viewing Logs","tags":["tip","工具"]},"fileAbsolutePath":"/Users/bytedance/mydemos/gatsby-hello-friend/content/posts/2019-03-08-Tips-On-Viewing-Logs.md"},"previous":{"fields":{"slug":"/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/"},"frontmatter":{"title":"Decode Video Using ffmpeg In Browser","tags":["Webassembly","Avtech","Emscripten","ffmpeg"]},"fileAbsolutePath":"/Users/bytedance/mydemos/gatsby-hello-friend/content/posts/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser.md"},"slug":"/2019-02-14-Setup-CI-in-docker/"}},"staticQueryHashes":["1425477374","3128451518"]}