{"componentChunkName":"component---src-templates-page-js","path":"/2019-09-24-Compile-Skia-Canvaskit-WASM/","result":{"data":{"site":{"siteMetadata":{"title":"HP goes FE","author":"@hikerpig"}},"markdownRemark":{"id":"bd80be3d-0d0c-5765-9246-9b06315b2cf3","html":"<p>Skia 是 Google 一个开源的跨平台图形库，用于 Android, Chromium, Flutter 等项目。目前项目内有在开发的一个 Skia + WebAssembly 版的 <a href=\"https://skia.org/user/modules/canvaskit\">CanvasKit</a>, 可以使用 JS    调用预先编译好的 c++ -> wasm 模块，为一些跨平台的图形项目(例如 lottie 的 Skia 版 <a href=\"https://skia.org/user/modules/skottie\">skottie</a> )移植到 web 端提供了一种新的可能性。</p>\n<h1 id=\"编译\" style=\"position:relative;\"><a href=\"#%E7%BC%96%E8%AF%91\" aria-label=\"编译 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>编译</h1>\n<h2 id=\"skia-代码准备\" style=\"position:relative;\"><a href=\"#skia-%E4%BB%A3%E7%A0%81%E5%87%86%E5%A4%87\" aria-label=\"skia 代码准备 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Skia 代码准备</h2>\n<p>下载和编译源码部分参看官方文档 <a href=\"https://skia.org/user/build\">How to build Skia</a>, 准备好梯子。</p>\n<p>canvaskit 相关源码都在 <code>modules/canvaskit</code> 目录下。</p>\n<p>拉取完代码后进行到同步依赖这一步就行。因为我们的构建脚本在 <code>modules/canvaskit</code> 里已经有了，可以不用从头编译所有 skia 样例代码和可执行程序，当然了你也可以跟着教程构建完整项目，加深对各功能模块的理解。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">python2 tools/git-sync-deps</code></pre></div>\n<h2 id=\"选择-emscripten-工具链\" style=\"position:relative;\"><a href=\"#%E9%80%89%E6%8B%A9-emscripten-%E5%B7%A5%E5%85%B7%E9%93%BE\" aria-label=\"选择 emscripten 工具链 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>选择 emscripten 工具链</h2>\n<p>使用 <a href=\"https://github.com/emscripten-core/emsdk\">emsdk</a> 安装 emscripten 相关工具链。</p>\n<p>emsdk 的各个发行 tag 里有几套命名，例如 <code>1.38.45</code> 和 <code>1.38.45-upstream</code>, 区别在于前者使用 fastcomp 后端，后者使用 llvm 后端。虽然 emscripten 官方推荐使用较新的 llvm 后端，但是在对 canvaskit 里实际使用的时候我发现 <code>wasm-ld</code> 步骤会报错，无法编译成功。\n因此选择 fastcomp 版。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">emsdk install 1.38.45</code></pre></div>\n<h2 id=\"canvaskitcompilesh\" style=\"position:relative;\"><a href=\"#canvaskitcompilesh\" aria-label=\"canvaskitcompilesh permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>canvaskit/compile.sh</h2>\n<p>这个编译脚本组织了调用 gn 和 em++ 的参数。有以下可选参数，不细看的话可以直接跳到下一步<a href=\"#%E7%BC%96%E8%AF%91%E6%AD%A5%E9%AA%A4\">编译步骤</a></p>\n<ul>\n<li><code>no_font</code> / <code>no_embedded_font</code> 字体管理相关，不指定的话会包括 skia fontmgr 相关内容，且内嵌一个默认字体 <code>NotoMono-Regular.ttf</code></li>\n<li><code>debug</code> / <code>profiling</code> 不指定的话默认按照 release 标准，开启最高代码优化模式。</li>\n<li><code>cpu</code> 不指定的话默认会加上 webgl 支持。</li>\n<li><code>no_canvas</code> 指定的话会排除掉 htmlcanvas/*.js 文件</li>\n</ul>\n<h2 id=\"编译步骤\" style=\"position:relative;\"><a href=\"#%E7%BC%96%E8%AF%91%E6%AD%A5%E9%AA%A4\" aria-label=\"编译步骤 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>编译步骤</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">source</span> ~/dev/emsdk/emsdk_env.sh\nemsdk activate <span class=\"token number\">1.38</span>.45\n\n<span class=\"token builtin class-name\">cd</span> /path/to/skia\n./modules/canvaskit/compile.sh</code></pre></div>\n<p>喝杯茶伸伸懒腰，大概四五分钟后，等到最后一步 log 'Generating final wasm' 完成，便可以在 <code>skia/out/canvaskit_wasm</code> 里找到结果文件。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">canvaskit.js  canvaskit.wasm ...</code></pre></div>\n<h2 id=\"tips\" style=\"position:relative;\"><a href=\"#tips\" aria-label=\"tips permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TIPS</h2>\n<ul>\n<li>不知道别的 emsdk 编译的之前结果有没有影响，所以如果更换了 emsdk 的版本，推荐开始前 <code>emcc --clear-cache</code></li>\n</ul>\n<h1 id=\"查看效果\" style=\"position:relative;\"><a href=\"#%E6%9F%A5%E7%9C%8B%E6%95%88%E6%9E%9C\" aria-label=\"查看效果 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>查看效果</h1>\n<p>使用刚才编译出来的 js/wasm 文件查看效果。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cd /path/to/skia/modules/canvaskit\nmkdir -p node_modules/canvaskit\nln -s /path/to/skia/out/canvaskit_wasm node_modules/canvaskit/bin</code></pre></div>\n<p>使用一个简单的 http 静态服务器程序 (如 <a href=\"https://www.npmjs.com/package/http-server\">http-server</a> ) ：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">http-server .</code></pre></div>\n<p>然后可以在 <code>http://127.0.0.1:8080/canvaskit/example.html</code> 和 <code>http://127.0.0.1:8080/canvaskit/extra.html</code> 页面里看示意效果。</p>","excerpt":"Skia 是 Google 一个开源的跨平台图形库，用于 Android, Chromium, Flutter 等项目。目前项目内有在开发的一个 Skia + WebAssembly 版的 CanvasKit, 可以使用 JS    调用预先编译好的 c++ -> wasm…","tableOfContents":"<ul>\n<li>\n<p><a href=\"/2019-09-24-Compile-Skia-Canvaskit-WASM/#%E7%BC%96%E8%AF%91\">编译</a></p>\n<ul>\n<li><a href=\"/2019-09-24-Compile-Skia-Canvaskit-WASM/#skia-%E4%BB%A3%E7%A0%81%E5%87%86%E5%A4%87\">Skia 代码准备</a></li>\n<li><a href=\"/2019-09-24-Compile-Skia-Canvaskit-WASM/#%E9%80%89%E6%8B%A9-emscripten-%E5%B7%A5%E5%85%B7%E9%93%BE\">选择 emscripten 工具链</a></li>\n<li><a href=\"/2019-09-24-Compile-Skia-Canvaskit-WASM/#canvaskitcompilesh\">canvaskit/compile.sh</a></li>\n<li><a href=\"/2019-09-24-Compile-Skia-Canvaskit-WASM/#%E7%BC%96%E8%AF%91%E6%AD%A5%E9%AA%A4\">编译步骤</a></li>\n<li><a href=\"/2019-09-24-Compile-Skia-Canvaskit-WASM/#tips\">TIPS</a></li>\n</ul>\n</li>\n<li><a href=\"/2019-09-24-Compile-Skia-Canvaskit-WASM/#%E6%9F%A5%E7%9C%8B%E6%95%88%E6%9E%9C\">查看效果</a></li>\n</ul>","fields":{"slug":"/2019-09-24-Compile-Skia-Canvaskit-WASM/","featureImageSrc":null},"frontmatter":{"title":"编译 Skia canvaskit.wasm","date":"2019-09-24","author":null,"tags":["Skia","WebAssembly"],"use_toc":true,"coverImage":null}}},"pageContext":{"type":"posts","next":{"fields":{"slug":"/2019-09-04-Detect-Computer-Resume-From-Sleep-In-Browser/"},"frontmatter":{"title":"在浏览器端检测电脑是否刚从休眠中醒来","tags":["浏览器"]},"fileAbsolutePath":"/Users/bytedance/mydemos/gatsby-hello-friend/content/posts/2019-09-04-Detect-Computer-Resume-From-Sleep-In-Browser.md"},"previous":{"fields":{"slug":"/2019-12-11-Browser-Storage-Limit/"},"frontmatter":{"title":"浏览器 IndexedDB 存储限制","tags":["IndexedDB","WebStorage","Browser"]},"fileAbsolutePath":"/Users/bytedance/mydemos/gatsby-hello-friend/content/posts/2019-12-11-Browser-Storage-Limit.md"},"slug":"/2019-09-24-Compile-Skia-Canvaskit-WASM/"}},"staticQueryHashes":["1425477374","3128451518"]}