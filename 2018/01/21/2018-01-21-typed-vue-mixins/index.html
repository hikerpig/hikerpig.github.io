<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="hikerpig,hikerpigwinnie@gmail.com"><title>typed vue mixins · HP goes FE</title><meta name="description" content="转到用 Typescript 写 Vue 应用以后，经过一轮工具链和依赖的洗礼，总算蹒跚地能走起来了，不过有一个很常用的功能 mixin，似乎还没有官方的解决方案。
既想享受 mixin 的灵活和方便，又想收获 ts 的类型系统带来的安全保障和开发时使用 IntelliSense 的顺滑体验。
vu"><meta name="keywords" content="Front-End,Programming,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/avatar.jpeg" class="sidebar__avatar"><h3 title=""><a href="/">HP goes FE</a></h3><div class="description"><p>Note for everything</p></div></div></div><ul class="social-links"><li><a href="http://github.com/https://github.com/hikerpig"><i class="fa fa-github"></i></a></li></ul><div class="sidebar-nav animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><a onclick="window.history.go(-1)" class="fa fa-chevron-left"></a></div></div></div><div class="footer"><a target="_blank" href="/"><span>Theme by  </span></a><a href="https://github/hikerpig">Hikerpig </a><span>forked from </span><a href="https://github.com/Ben02/hexo-theme-Anatole">Anatole</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo</a></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h1><a>typed vue mixins</a></h1></div><div class="post-content"><p>转到用 Typescript 写 Vue 应用以后，经过一轮工具链和依赖的洗礼，总算蹒跚地能走起来了，不过有一个很常用的功能 mixin，似乎还没有官方的解决方案。</p>
<p>既想享受 mixin 的灵活和方便，又想收获 ts 的类型系统带来的安全保障和开发时使用 IntelliSense 的顺滑体验。</p>
<p>vuejs 官方组织里有一个 ‘vue-class-component’ 以及连带推荐的 ‘vue-property-decorator’，都没有相应实现。翻了下前者的 issue，有一条挂了好些时间的待做 feature 就是 mixin 的支持。</p>
<p>也不是什么复杂的事，自己写一个吧。</p>
<blockquote>
<p>后注：vue-class-component 6.2.0 开始提供 <code>mixins</code> 方法，和本文的实现思路相似。</p>
</blockquote>
<h2 id="实现">实现</h2>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue, &#123; VueConstructor &#125; <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> VClass&lt;T&gt; = &#123;</span><br><span class="line">  <span class="keyword">new</span>(): T</span><br><span class="line">&#125; &amp; Pick&lt;VueConstructor, keyof VueConstructor&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * mixins for class style vue component</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Mixins</span>&lt;<span class="title">A</span>&gt;(<span class="params">c: VClass&lt;A&gt;</span>): <span class="title">VClass</span>&lt;<span class="title">A</span>&gt;</span></span><br><span class="line"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">Mixins</span>&lt;<span class="title">A</span>, <span class="title">B</span>&gt;(<span class="params">c: VClass&lt;A&gt;, c1: VClass&lt;B&gt;</span>): <span class="title">VClass</span>&lt;<span class="title">A</span>&amp;<span class="title">B</span>&gt;</span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">Mixins</span>&lt;<span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>&gt;(<span class="params">c: VClass&lt;A&gt;, c1: VClass&lt;B&gt;, c2: VClass&lt;C&gt;</span>): <span class="title">VClass</span>&lt;<span class="title">A</span>&amp;<span class="title">B</span>&amp;<span class="title">C</span>&gt;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="function"><span class="keyword">function</span> <span class="title">Mixins</span>&lt;<span class="title">T</span>&gt;(<span class="params">c: VClass&lt;T&gt;, ...traits: <span class="built_in">Array</span>&lt;VClass&lt;T&gt;&gt;</span>): <span class="title">VClass</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">  <span class="title">return</span> <span class="title">c</span>.<span class="title">extend</span>(<span class="params">&#123;</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="params">    mixins: traits</span></span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function"><span class="params">  &#125;</span>)</span></span></span></span><br><span class="line"><span class="function"><span class="function"><span class="function">&#125;</span></span></span></span><br></pre></td></tr></table></figure>
<p>声明 <code>VClass&lt;T&gt;</code> 可作为 T 的类构造器。同时通过 <code>Pick</code> 拿到 Vue 的构造器上的静态方法（extend/mixin 之类），如此才能够支持下面这段中的真正实现，通过调用一个 Vue 的子类构造器上的 <code>extend</code> 方法生成新的子类构造器。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Mixins</span>&lt;<span class="title">T</span>&gt;(<span class="params">c: VClass&lt;T&gt;, ...traits: <span class="built_in">Array</span>&lt;VClass&lt;T&gt;&gt;</span>): <span class="title">VClass</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> c.extend(&#123;</span><br><span class="line">    mixins: traits</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至于 ABC 这个纯粹是类型声明的体力活了。</p>
<h2 id="使用">使用</h2>
<p>实际使用时:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Component, Vue &#125; <span class="keyword">from</span> <span class="string">'vue-property-decorator'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Mixins &#125; <span class="keyword">from</span> <span class="string">'../../util/mixins'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> PageMixin <span class="keyword">extends</span> Vue &#123;</span><br><span class="line">  title = <span class="string">'Test Page'</span></span><br><span class="line"></span><br><span class="line">  redirectTo(path: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'calling reidrectTo'</span>, path)</span><br><span class="line">    <span class="keyword">this</span>.$router.push(&#123; path &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> IDisposable &#123;</span><br><span class="line">  dispose(...args: <span class="built_in">any</span>[]): <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> DisposableMixin <span class="keyword">extends</span> Vue &#123;</span><br><span class="line">  _disposables: IDisposable[]</span><br><span class="line"></span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'disposable mixin created'</span>);</span><br><span class="line">    <span class="keyword">this</span>._disposables = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  beforeDestroy() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'about to clear disposables'</span>)</span><br><span class="line">    <span class="keyword">this</span>._disposables.map(<span class="function">(<span class="params">d</span>) =&gt;</span> &#123;</span><br><span class="line">      d.dispose()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>._disposables</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  registerDisposable(d: IDisposable) &#123;</span><br><span class="line">    <span class="keyword">this</span>._disposables.push(d)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  template: <span class="string">`</span></span><br><span class="line"><span class="string">  &lt;div&gt;</span></span><br><span class="line"><span class="string">    &lt;h1&gt;&#123;&#123; title &#125;&#125;&lt;/h1&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;Counted: &#123;&#123; counter &#125;&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> TimerPage <span class="keyword">extends</span> Mixins(PageMixin, DisposableMixin) &#123;</span><br><span class="line">  counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  mounted() &#123;</span><br><span class="line">    <span class="keyword">const</span> timer = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.counter++ &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.redirectTo(<span class="string">'/otherpage'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'count to'</span>, <span class="keyword">this</span>.counter);</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.registerDisposable(&#123;</span><br><span class="line">      dispose() &#123;</span><br><span class="line">        clearInterval(timer)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">count to 1</span><br><span class="line">count to 2</span><br><span class="line">count to 3</span><br><span class="line">calling reidrectTo /otherpage</span><br><span class="line">about to clear disposables</span><br></pre></td></tr></table></figure>
<p>注意到直接 <code>extends Vue</code> 的 <code>DisposableMixin</code> 并不是一个有效的 Vue 组件，也不可以直接在 <code>mixins</code> 选项里使用，如果要被以 <code>Vue.extend</code> 方式扩展的自定义组件使用，记住使用 <code>Component</code> 包装一层。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ExtendedComponent = Vue.extend(&#123;</span><br><span class="line">  name: <span class="string">'ExtendedComponent'</span>,</span><br><span class="line">  mixins: [Component(DisposableMixin)],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="abstract-class">Abstract class</h2>
<p>在业务系统中会使用到的 Mixin 其实多数情况下会更复杂，提供一些基础功能，但有些部分需要留给继承者自行实现，这个时候使用抽象类就很合适。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> AbstractMusicPlayer <span class="keyword">extends</span> Vue &#123;</span><br><span class="line">  <span class="keyword">abstract</span> audioSrc: <span class="built_in">string</span></span><br><span class="line">  </span><br><span class="line">  playing = <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  togglePlay() &#123;</span><br><span class="line">    <span class="keyword">this</span>.playing = !<span class="keyword">this</span>.playing</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> MusicPlayerA <span class="keyword">extends</span> AbstractMusicPlayer &#123;</span><br><span class="line">  audioSrc = <span class="string">'/audio-a.mp3'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> MusicPlayerB <span class="keyword">extends</span> AbstractMusicPlayer &#123;</span><br><span class="line">  staticBase = <span class="string">'/statics'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> audioSrc() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;this.staticBase&#125;</span>/audio-b.mp3`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但抽象类是无法被实例化的，并不满足 <code>{ new(): T }</code> 这个要求，因此只能被继承，而不能被混入，由于同样的原因，抽象类也无法被 ‘vue-class-component’ 的 <code>Component</code> 函数装饰。</p>
<p>这时候只好将实现了的功能写入 Mixin 中，待实现的功能放到接口里，让具体类来实现。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> IMusicSourceProvider &#123;</span><br><span class="line">  audioSrc: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @implements IPlayerImplementation</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> PlayerMixin <span class="keyword">extends</span> Vue &#123;</span><br><span class="line">  <span class="comment">/** @abstract */</span></span><br><span class="line">  audioSrc: <span class="built_in">string</span></span><br><span class="line"></span><br><span class="line">  logSrc() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.audioSrc)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> IPlayerImplementation <span class="keyword">extends</span> IMusicSourceProvider &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> RealPlayer <span class="keyword">extends</span> Mixins(PlayerMixin) <span class="keyword">implements</span> IPlayerImplementation &#123;</span><br><span class="line">  audioSrc = <span class="string">'/audio-c.mp3'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种欺骗编译器的方式其实还是比较拙劣的，如果一个具体类继承了 PlayerMixin，却没有显示声明实现 <code>IPlayerImplementation</code>，编译器无法告诉你这个错误。我们只能在代码里小心翼翼写上注释，期待使用者不要忘了这件事。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-01-21</span><i class="fa fa-tag"></i><a href="/categories/前端/" title="前端" class="tag">前端 </a><a href="/tags/Typescript/" title="Typescript" class="tag">Typescript </a><a href="/tags/Vue/" title="Vue" class="tag">Vue </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://hikerpig.github.io/2018/01/21/2018-01-21-typed-vue-mixins/,HP goes FE,typed vue mixins,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2018/01/24/2017-09-07-Using-Object.create/" title="使用 Object.create(null) 创建空对象" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2017/09/25/2017-09-25-ES6+Babel-little-bug-under-IE11/" title="ES6 Class 和 Babel 6 在 IE &lt;= 10 时候的一个坑" class="btn">下一篇</a></li></ul></div><div id="comments"><div id="gitalk-container"></div></div><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: '0b21579fda2f1d2e73f4',
  clientSecret: 'abc0351a314cc46bb3d58b6dad62c670c2d1e8f9',
  repo: 'hikerpig.github.io',
  owner: 'hikerpig',
  admin: 'hikerpig',
  labels: ['Gitalk'],
  id: '2018/01/21/2018-01-21-typed-vue-mixins/',
  title: 'typed vue mixins',
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')
</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>