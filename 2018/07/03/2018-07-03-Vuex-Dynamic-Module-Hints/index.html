<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="hikerpig,hikerpigwinnie@gmail.com"><title>Vuex æ¨¡å—åŠ¨æ€æ³¨å†Œçš„ä¸€äº›å®è·µç»éªŒ Â· HP goes FE</title><meta name="description" content="å‰è¨€
æ„å»ºå¤§å‹ SPA åº”ç”¨æ—¶ï¼Œä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ä¼˜åŒ–æ‰‹æ®µï¼Œåœ¨ Vue ç”Ÿæ€ä¸‹ï¼Œä½¿ç”¨ vue-router å¾ˆå®¹æ˜“å®ç°ç»„ä»¶çš„æ‡’åŠ è½½ã€‚
ä½†åº”ç”¨é‡Œé™¤äº†ç»„ä»¶ï¼Œè¿˜æœ‰åºå¤§çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™éƒ¨åˆ†å¦‚ä½•åˆ†å‰²å’Œæ‡’åŠ è½½æ¯”è¾ƒåˆé€‚å‘¢ï¼Ÿ
ä½¿ç”¨ Vuex ç®¡ç†çŠ¶æ€çš„è¯ï¼Œå…¶æä¾›äº†æ–¹æ³• registerModule ç”¨äºåŠ¨æ€"><meta name="keywords" content="Vue,Vuex"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/avatar.jpeg" class="sidebar__avatar"><h3 title><a href="/">HP goes FE</a></h3><div class="description"><p>Note for everything</p></div></div></div><ul class="social-links"><li><a href="http://github.com/hikerpig"><i class="fa fa-github"></i></a></li></ul><div class="sidebar-nav animated fadeInDown"><div class="nav"><li><a href="/">é¦–é¡µ</a></li><li><a href="/archives">å½’æ¡£</a></li></div><div class="information"><div class="back_btn"><a onclick="window.history.go(-1)" class="fa fa-chevron-left"></a></div></div></div><div class="footer"><a target="_blank" href="/"><span>Theme by  </span></a><a href="https://github/hikerpig">Hikerpig </a><span>forked from </span><a href="https://github.com/Ben02/hexo-theme-Anatole">Anatole</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo</a></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h1><a>Vuex æ¨¡å—åŠ¨æ€æ³¨å†Œçš„ä¸€äº›å®è·µç»éªŒ</a></h1></div><div class="post-content"><h1 id="å‰è¨€">å‰è¨€</h1>
<p>æ„å»ºå¤§å‹ SPA åº”ç”¨æ—¶ï¼Œä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ä¼˜åŒ–æ‰‹æ®µï¼Œåœ¨ Vue ç”Ÿæ€ä¸‹ï¼Œä½¿ç”¨ vue-router å¾ˆå®¹æ˜“å®ç°ç»„ä»¶çš„æ‡’åŠ è½½ã€‚</p>
<p>ä½†åº”ç”¨é‡Œé™¤äº†ç»„ä»¶ï¼Œè¿˜æœ‰åºå¤§çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™éƒ¨åˆ†å¦‚ä½•åˆ†å‰²å’Œæ‡’åŠ è½½æ¯”è¾ƒåˆé€‚å‘¢ï¼Ÿ</p>
<p>ä½¿ç”¨ Vuex ç®¡ç†çŠ¶æ€çš„è¯ï¼Œå…¶æä¾›äº†æ–¹æ³• <code>registerModule</code> ç”¨äº<a href="https://vuex.vuejs.org/guide/modules.html#dynamic-module-registration" target="_blank" rel="noopener">åŠ¨æ€æ³¨å†Œ</a> Moduleã€‚</p>
<p>å› æ­¤æŸä¸ªé¡µé¢ç‹¬æœ‰çš„ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†ï¼Œåœ¨åˆå§‹åŒ–å…¨å±€ store çš„æ—¶å€™å¯ä»¥ä¸ç”¨å¼•å…¥ï¼Œä¹‹ååœ¨è¯¥é¡µé¢è·¯ç”±ç»„ä»¶ä¸­å†å¼•å…¥å’Œæ³¨å†Œ Vuex æ¨¡å—ã€‚</p>
<h1 id="ç®€å•çš„ç¤ºä¾‹">ç®€å•çš„ç¤ºä¾‹</h1>
<pre><code class="hljs javascript"><span class="hljs-keyword">const</span> PageA = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/PageA.js'</span>)

<span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> VueRouter(&#123;
  <span class="hljs-attr">routes</span>: [
    &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">'/page-a'</span>, <span class="hljs-attr">component</span>: PageA &#125;
  ]
&#125;)</code></pre>
<p>ç®€å•çš„ Vuex æ¨¡å—ï¼š</p>
<pre><code class="hljs javascript"><span class="hljs-comment">// store/modules/page-a.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> VUEX_NS = <span class="hljs-string">'page-a'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;
  <span class="hljs-attr">namespaced</span>: <span class="hljs-literal">true</span>,
  state() &#123;
    <span class="hljs-keyword">return</span> &#123;
      <span class="hljs-attr">inventory</span>: &#123;
        <span class="hljs-attr">list</span>: []
      &#125;
    &#125;
  &#125;,
  <span class="hljs-attr">getters</span>: &#123;
    inventoryList(state) &#123;
      <span class="hljs-keyword">return</span> state.inventory.list
    &#125;
  &#125;
&#125;</code></pre>
<p>å®è·µæ—¶é­é‡äº†å‡ ä¸ªé—®é¢˜ï¼š</p>
<h2 id="é—®é¢˜-1æœåŠ¡å™¨å®¢æˆ·ç«¯-åœ¨å°šæœªæ³¨å†Œ-module-æ—¶è°ƒç”¨å…¶ä¸‹çš„-actionmutation-vuex-å› æ‰¾ä¸åˆ°å¯¹åº”å‡½æ•°è€Œå‡ºé”™">é—®é¢˜ 1ï¼šæœåŠ¡å™¨/å®¢æˆ·ç«¯ åœ¨å°šæœªæ³¨å†Œ Module æ—¶ï¼Œè°ƒç”¨å…¶ä¸‹çš„ action/mutation ï¼ŒVuex å› æ‰¾ä¸åˆ°å¯¹åº”å‡½æ•°è€Œå‡ºé”™</h2>
<pre><code class="hljs javascript"><span class="hljs-comment">// views/PageA.js</span>

<span class="hljs-keyword">import</span> PAGE_A_MODULE, &#123; VUEX_NS &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'store/modules/page-a'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;
  <span class="hljs-attr">name</span>: <span class="hljs-string">'PageA'</span>,
  beforeCreate() &#123;
    <span class="hljs-keyword">this</span>.$store.registerModule(VUEX_NS, PAGE_A_MODULE)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.$store.dispatch(<span class="hljs-string">`<span class="hljs-subst">$&#123;VUEX_NS&#125;</span>/fetchInventory`</span>)
  &#125;,
&#125;</code></pre>
<h3 id="è€ƒè™‘æœåŠ¡å™¨ç«¯é¢„å–æ•°æ®æ³¨å…¥ç»™å®¢æˆ·ç«¯çš„æ—¶å€™">è€ƒè™‘æœåŠ¡å™¨ç«¯é¢„å–æ•°æ®æ³¨å…¥ç»™å®¢æˆ·ç«¯çš„æ—¶å€™</h3>
<p>å®¢æˆ·ï¼ˆæµè§ˆå™¨ï¼‰ç«¯åˆå§‹åŒ–ä»£ç ï¼Œåœ¨åˆå§‹åŒ– router ä¹‹å‰ï¼Œç»™ Vuex å…¨å±€ store æ³¨å…¥æ•°æ®ï¼š</p>
<pre><code class="hljs js"><span class="hljs-comment">// entry-client.js</span>
store.replaceState(<span class="hljs-built_in">window</span>.__INITIAL_STATE__)</code></pre>
<p>æ­¤å¤„çš„ <code>__INITIAL_STATE__</code> æ˜¯ Vue SSR æä¾›çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œä½¿å¾—æµè§ˆå™¨ç«¯å¯ä»¥å¤ç”¨æœåŠ¡å™¨ç«¯å·²ç»é¢„å–è¿‡çš„æ•°æ®ã€‚</p>
<pre><code class="hljs js"><span class="hljs-comment">// åœ¨æ‰€æœ‰é¢„å–é’©å­(preFetch hook) resolve åï¼Œ</span>
<span class="hljs-comment">// æˆ‘ä»¬çš„ store ç°åœ¨å·²ç»å¡«å……å…¥æ¸²æŸ“åº”ç”¨ç¨‹åºæ‰€éœ€çš„çŠ¶æ€ã€‚</span>
<span class="hljs-comment">// å½“æˆ‘ä»¬å°†çŠ¶æ€é™„åŠ åˆ°ä¸Šä¸‹æ–‡ï¼Œ</span>
<span class="hljs-comment">// å¹¶ä¸” `template` é€‰é¡¹ç”¨äº renderer æ—¶ï¼Œ</span>
<span class="hljs-comment">// çŠ¶æ€å°†è‡ªåŠ¨åºåˆ—åŒ–ä¸º `window.__INITIAL_STATE__`ï¼Œå¹¶æ³¨å…¥ HTMLã€‚</span>
context.state = store.state</code></pre>
<p>æ­¤å¤„çš„ <code>asyncData</code> ä¸ <a href="https://ssr.vuejs.org/zh/guide/data.html#%E6%95%B0%E6%8D%AE%E9%A2%84%E5%8F%96%E5%AD%98%E5%82%A8%E5%AE%B9%E5%99%A8-data-store" target="_blank" rel="noopener">Vue SSR æ–‡æ¡£ä¸­çš„ä¾‹å­</a>ç±»ä¼¼ï¼Œä¸ Nuxt.js ä¸­çš„åŒåå‡½æ•°ç”¨æ³•ç•¥æœ‰ä¸åŒã€‚</p>
<p><code>prepareVuex</code> ä¸ºè‡ªå®šä¹‰çš„ç»„ä»¶é’©å­å‡½æ•°ï¼Œä¼šå…ˆäº asyncData è°ƒç”¨ï¼Œå…·ä½“è¿‡ç¨‹ä¹‹åæ¢è®¨ã€‚</p>
<pre><code class="hljs diff"> export default &#123;
   name: 'PageA',
<span class="hljs-deletion">-  beforeCreate() &#123;</span>
<span class="hljs-deletion">-    this.$store.registerModule(VUEX_NS, PAGE_A_MODULE)</span>
<span class="hljs-deletion">-    return this.$store.dispatch(`$&#123;VUEX_NS&#125;/fetchInventory`)</span>
<span class="hljs-addition">+  prepareVuex(&#123; store &#125;) &#123;</span>
<span class="hljs-addition">+    store.registerModule(VUEX_NS, PAGE_A_MODULE)</span>
<span class="hljs-addition">+  &#125;,</span>
<span class="hljs-addition">+  asyncData(&#123; store &#125;) &#123;</span>
<span class="hljs-addition">+    return store.dispatch(`$&#123;VUEX_NS&#125;/fetchInventory`)</span>
   &#125;,
 &#125;</code></pre>
<p>æ­¤æ—¶ä¼šé‡è§</p>
<h2 id="é—®é¢˜2-å®¢æˆ·ç«¯æ²¡æœ‰ç”¨ä¸ŠæœåŠ¡å™¨ç«¯é¢„å–çš„æ•°æ®">é—®é¢˜2: å®¢æˆ·ç«¯æ²¡æœ‰ç”¨ä¸ŠæœåŠ¡å™¨ç«¯é¢„å–çš„æ•°æ®</h2>
<p>è§£å†³æ–¹å¼ï¼š</p>
<pre><code class="hljs diff"> export default &#123;
   name: 'PageA',
<span class="hljs-deletion">-  prepareVuex(&#123; store &#125;) &#123;</span>
<span class="hljs-deletion">-    store.registerModule(VUEX_NS, PAGE_A_MODULE)</span>
<span class="hljs-addition">+  prepareVuex(&#123; store, isClientInitialRoute &#125;) &#123;</span>
<span class="hljs-addition">+    store.registerModule(VUEX_NS, PAGE_A_MODULE, &#123; preserveState: isClientInitialRoute &#125;)</span>
   &#125;,
   asyncData(&#123; store &#125;) &#123;
     return store.dispatch(`$&#123;VUEX_NS&#125;/fetchInventory`)
   &#125;,
<span class="hljs-addition">+  beforeDestroy() &#123;</span>
<span class="hljs-addition">+    // é”€æ¯è¯¥æ¨¡å—</span>
<span class="hljs-addition">+    this.$store.unregisterModule(VUEX_NS)</span>
<span class="hljs-addition">+  &#125;</span>
 &#125;</code></pre>
<p>æ³¨å†Œ Vuex æ¨¡å—çš„æ—¶å€™ä½¿ç”¨äº† <code>preserveState</code> ï¼Œè‹¥å¯ç”¨æ­¤é€‰é¡¹ï¼Œæ³¨å†Œ Module æ—¶è‹¥ <code>store.state[namespace]</code> ä¸‹å·²å­˜åœ¨æ•°æ®ï¼Œä¾¿ä¸ä¼šä½¿ç”¨å£°æ˜ vuex æ¨¡å—æ—¶çš„åˆå§‹ state è¦†ç›–å·²æœ‰æ•°æ®ã€‚ä½†éœ€è¦æ³¨æ„ï¼Œè‹¥ state ä¸­æ²¡æœ‰ namespace ç›¸åº”æ•°æ®å´å¼€å¯äº†æ­¤é€‰é¡¹ï¼ŒVuex è¿˜æ˜¯ä¼šæŠ¥é”™ã€‚å› æ­¤æ­¤å¤„æ·»åŠ äº†ä¸€ä¸ªè¾“å…¥å‚æ•° <code>isClientInitialRoute</code> ï¼Œ åªæœ‰åœ¨å®¢æˆ·ç«¯åˆæ¬¡è¿›å…¥é¡µé¢ï¼ˆå¯ä»¥ä½¿ç”¨æœåŠ¡å™¨é¢„å–æ•°æ®ï¼‰æ—¶æ‰å¼€å¯ <code>preserveState</code> é€‰é¡¹ã€‚</p>
<h2 id="é—®é¢˜3-ç»„ä»¶çƒ­æ›´æ–°æ—¶vuex-æ¨¡å—è¢«é”€æ¯">é—®é¢˜3: ç»„ä»¶çƒ­æ›´æ–°æ—¶ï¼ŒVuex æ¨¡å—è¢«é”€æ¯</h2>
<p>å¼€å‘æœŸé—´ä½¿ç”¨ HotModuleReplacementPlugin å’Œ vue-loaderï¼Œè‹¥æ”¹å˜äº† PageA.js ä¸­çš„ä»£ç ï¼Œä¼šè§¦å‘çƒ­æ›´æ–°ã€‚åœ¨ <a href="https://github.com/vuejs/vue-hot-reload-api/blob/master/src/index.js" target="_blank" rel="noopener">vue-hot-reload-api</a> ä¸­ï¼Œå½“ä½¿ç”¨ vue-hot-reload-api çš„ <code>reload</code> æ–¹æ³•å¤„ç†ç»„ä»¶å®ä¾‹æ—¶ï¼Œè¯¥å®ä¾‹ä¼šè¢«é”€æ¯è€Œåé‡æ–°åˆ›å»ºã€‚<code>beforeDestroy</code> ä¸­é”€æ¯äº† Vuex çš„ <code>page-a</code> æ¨¡å—ï¼Œå´æ²¡æœ‰è°ƒç”¨ <code>prepareVuex</code> æ–¹æ³•é‡æ–°æ³¨å†Œï¼Œå› æ­¤çƒ­æ›´æ–°ä¹‹åï¼Œä½¿ç”¨è¯¥æ¨¡å—ä¹Ÿä¼šæŠ¥é”™ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<pre><code class="hljs diff">   asyncData(&#123; store &#125;) &#123;
     return store.dispatch(`$&#123;VUEX_NS&#125;/fetchInventory`)
   &#125;,
<span class="hljs-deletion">-  beforeDestroy() &#123;</span>
<span class="hljs-deletion">-    // é”€æ¯è¯¥æ¨¡å—</span>
<span class="hljs-deletion">-    this.$store.unregisterModule(VUEX_NS)</span>
<span class="hljs-addition">+  beforeRouteLeave(to, from, next) &#123;</span>
<span class="hljs-addition">+    this.$once('hook:beforeDestroy', () =&gt; &#123;</span>
<span class="hljs-addition">+      // é”€æ¯è¯¥æ¨¡å—</span>
<span class="hljs-addition">+      this.$store.unregisterModule(VUEX_NS)</span>
<span class="hljs-addition">+    &#125;)</span>
<span class="hljs-addition">+    next()</span>
   &#125;
 &#125;</code></pre>
<p>ä»”ç»†æƒ³æƒ³ï¼Œæ³¨å†Œæ¨¡å—çš„æ—¶æœºæ˜¯ä¸è·¯ç”±ç›¸å…³çš„ï¼ˆè¿›å…¥é¡µé¢ä¹‹å‰ï¼‰ï¼Œé‚£ä¹ˆé”€æ¯çš„æ—¶æœºä¹Ÿå¯ä»¥ä¸è·¯ç”±ç›¸å…³ã€‚ä¸è¿‡å¹¶ä¸é€‚åˆåœ¨ <code>beforeRouteLeave</code> é’©å­ä¸­ç«‹åˆ»é”€æ¯æ¨¡å—ã€‚å› ä¸ºæ ¹æ®ä»¥ä¸‹ vue-router æ–‡æ¡£å†…å®¹ï¼Œåœ¨æ­¤é’©å­è¢«è°ƒç”¨å®Œæˆæ—¶ï¼Œæ•´ä¸ªé¡µé¢è¿˜æ˜¯åœ¨æ­£å¸¸å·¥ä½œçš„ï¼ˆç¬¬2æ­¥åˆ°ç¬¬11æ­¥ä¸­é—´ï¼‰ï¼Œä»æœªè¿›å…¥ç»„ä»¶çš„ destroy è¿‡ç¨‹ï¼Œæ­¤æ—¶é”€æ¯æ¨¡å—ä¼šå¯¼è‡´ä¾èµ–å…¶çš„æ‰€æœ‰ç»„ä»¶å¼‚å¸¸ã€‚</p>
<blockquote>
<p><cite><a href="https://router.vuejs.org/zh/guide/advanced/navigation-guards.html#%E5%AE%8C%E6%95%B4%E7%9A%84%E5%AF%BC%E8%88%AA%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B" target="_blank" rel="noopener">vue-router æ–‡æ¡£ä¸­å…³äºå¯¼èˆªè§£ææµç¨‹çš„éƒ¨åˆ†</a></cite></p>
<ol type="1">
<li>å¯¼èˆªè¢«è§¦å‘ã€‚</li>
<li>åœ¨å¤±æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨ç¦»å¼€å®ˆå«ã€‚</li>
<li>è°ƒç”¨å…¨å±€çš„ beforeEach å®ˆå«ã€‚</li>
<li>åœ¨é‡ç”¨çš„ç»„ä»¶é‡Œè°ƒç”¨ beforeRouteUpdate å®ˆå« (2.2+)ã€‚</li>
<li>åœ¨è·¯ç”±é…ç½®é‡Œè°ƒç”¨ beforeEnterã€‚</li>
<li>è§£æå¼‚æ­¥è·¯ç”±ç»„ä»¶ã€‚</li>
<li>åœ¨è¢«æ¿€æ´»çš„ç»„ä»¶é‡Œè°ƒç”¨ beforeRouteEnterã€‚</li>
<li>è°ƒç”¨å…¨å±€çš„ beforeResolve å®ˆå« (2.5+)ã€‚</li>
<li>å¯¼èˆªè¢«ç¡®è®¤ã€‚</li>
<li>è°ƒç”¨å…¨å±€çš„ afterEach é’©å­ã€‚</li>
<li>è§¦å‘ DOM æ›´æ–°ã€‚</li>
<li>ç”¨åˆ›å»ºå¥½çš„å®ä¾‹è°ƒç”¨ beforeRouteEnter å®ˆå«ä¸­ä¼ ç»™ next çš„å›è°ƒå‡½æ•°ã€‚</li>
</ol>
</blockquote>
<p>å› æ­¤å®‰å…¨çš„æ¨¡å—é”€æ¯æ—¶æœºéœ€è¦åœ¨ DOM æ›´æ–°ä¸­æˆ–åï¼Œæ—§çš„é¡µé¢ç»„ä»¶å®ä¾‹é”€æ¯è¿‡ç¨‹è°ƒç”¨æ—¶ã€‚</p>
<h1 id="ç›¸å…³ä»£ç ">ç›¸å…³ä»£ç </h1>
<p>æœ€åçš„ PageA.jsï¼š</p>
<pre><code class="hljs js"><span class="hljs-keyword">import</span> PAGE_A_MODULE, &#123; VUEX_NS &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'store/modules/page-a'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;
  <span class="hljs-attr">name</span>: <span class="hljs-string">'PageA'</span>,
  prepareVuex(&#123; store, isClientInitialRoute &#125;) &#123;
    store.registerModule(VUEX_NS, PAGE_A_MODULE, &#123; <span class="hljs-attr">preserveState</span>: isClientInitialRoute &#125;)
  &#125;,
  asyncData(&#123; store &#125;) &#123;
    <span class="hljs-keyword">return</span> store.dispatch(<span class="hljs-string">`<span class="hljs-subst">$&#123;VUEX_NS&#125;</span>/fetchInventory`</span>)
  &#125;,
  beforeRouteLeave(to, <span class="hljs-keyword">from</span>, next) &#123;
    <span class="hljs-keyword">this</span>.$once(<span class="hljs-string">'hook:beforeDestroy'</span>, () =&gt; &#123;
      <span class="hljs-comment">// é”€æ¯è¯¥æ¨¡å—</span>
      <span class="hljs-keyword">this</span>.$store.unregisterModule(VUEX_NS)
    &#125;)
    next()
  &#125;
&#125;</code></pre>
<p>ä¸¤ç«¯çš„å…¥å£æ–‡ä»¶ä¸­ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs typescript"><span class="hljs-comment">// router-util.ts</span>

<span class="hljs-keyword">import</span> Vue, &#123; VueConstructor &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">type</span> VueCtor = VueConstructor&lt;<span class="hljs-built_in">any</span>&gt;

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getHookFromComponent</span>(<span class="hljs-params">compo: <span class="hljs-built_in">any</span>, name: <span class="hljs-built_in">string</span></span>) </span>&#123;
  <span class="hljs-keyword">return</span> compo[name] || (compo.options &amp;&amp; compo.options[name])
&#125;

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callComponentsHookWith</span>(<span class="hljs-params">compoList: VueCtor[], hookName: <span class="hljs-built_in">string</span>, context: <span class="hljs-built_in">any</span></span>) </span>&#123;
  <span class="hljs-keyword">return</span> compoList.map(<span class="hljs-function">(<span class="hljs-params">component</span>) =&gt;</span> &#123;
    <span class="hljs-keyword">const</span> hook = getHookFromComponent(component, hookName)
    <span class="hljs-keyword">if</span> (hook) &#123;
      <span class="hljs-keyword">return</span> hook(context)
    &#125;
  &#125;).filter(_ =&gt; _)
&#125;</code></pre>
<pre><code class="hljs js"><span class="hljs-comment">// entry-server.js</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> context =&gt; &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;
    <span class="hljs-comment">// set router's location</span>
    router.push(context.url)

    router.onReady(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;
      <span class="hljs-keyword">const</span> matchedComponents = router.getMatchedComponents()

      <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">// åŠ ä¸Š try/catch é¿å…æ­¤ block å†…æŠ›å‡ºçš„é”™è¯¯é€ æˆ promise unhandledRejection</span>
        callComponentsHookWith(matchedComponents, <span class="hljs-string">'prepareVuex'</span>, &#123; store &#125;)

        <span class="hljs-keyword">const</span> asyncDataResults = callComponentsHookWith(matchedComponents, <span class="hljs-string">'asyncData'</span>,
          &#123;
            store,
            <span class="hljs-attr">route</span>: router.currentRoute,
          &#125;
        )
        <span class="hljs-built_in">Promise</span>.all(asyncDataResults).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;
          context.state = store.state
          resolve(app)
        &#125;).catch(reject)

      &#125; <span class="hljs-keyword">catch</span>(err) &#123;
        reject(err)
      &#125;
    &#125;, reject)
  &#125;)
&#125;</code></pre>
<pre><code class="hljs js"><span class="hljs-comment">// entry-client.js</span>

router.onReady(<span class="hljs-function">(<span class="hljs-params">initialRoute</span>) =&gt;</span> &#123;
  <span class="hljs-keyword">const</span> initialMatched = router.getMatchedComponents(initialRoute)
  callComponentsHookWith(initialMatched, <span class="hljs-string">'prepareVuex'</span>, &#123; store, <span class="hljs-attr">isClientInitialRoute</span>: <span class="hljs-literal">true</span> &#125;)

  router.beforeResolve(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> &#123;
    <span class="hljs-keyword">const</span> matched = router.getMatchedComponents(to)

    callComponentsHookWith(matched, <span class="hljs-string">'prepareVuex'</span>, &#123; store &#125;)

    <span class="hljs-built_in">Promise</span>.all(callComponentsHookWith(activated, <span class="hljs-string">'asyncData'</span>, &#123; store, <span class="hljs-attr">route</span>: to &#125;))
      .then(next)
      .catch(next)
  &#125;)

  <span class="hljs-comment">// actually mount to DOM</span>
  app.$mount(<span class="hljs-string">'#app'</span>)
&#125;)</code></pre>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-07-03</span><i class="fa fa-tag"></i><a href="/categories/å‰ç«¯/" title="å‰ç«¯" class="tag">å‰ç«¯ </a><a href="/tags/Vue/" title="Vue" class="tag">Vue </a><a href="/tags/Vuex/" title="Vuex" class="tag">Vuex </a></div></div></div></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#å‰è¨€"><span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ç®€å•çš„ç¤ºä¾‹"><span class="toc-text">ç®€å•çš„ç¤ºä¾‹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#é—®é¢˜-1æœåŠ¡å™¨å®¢æˆ·ç«¯-åœ¨å°šæœªæ³¨å†Œ-module-æ—¶è°ƒç”¨å…¶ä¸‹çš„-actionmutation-vuex-å› æ‰¾ä¸åˆ°å¯¹åº”å‡½æ•°è€Œå‡ºé”™"><span class="toc-text">é—®é¢˜ 1ï¼šæœåŠ¡å™¨/å®¢æˆ·ç«¯ åœ¨å°šæœªæ³¨å†Œ Module æ—¶ï¼Œè°ƒç”¨å…¶ä¸‹çš„ action/mutation ï¼ŒVuex å› æ‰¾ä¸åˆ°å¯¹åº”å‡½æ•°è€Œå‡ºé”™</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#è€ƒè™‘æœåŠ¡å™¨ç«¯é¢„å–æ•°æ®æ³¨å…¥ç»™å®¢æˆ·ç«¯çš„æ—¶å€™"><span class="toc-text">è€ƒè™‘æœåŠ¡å™¨ç«¯é¢„å–æ•°æ®æ³¨å…¥ç»™å®¢æˆ·ç«¯çš„æ—¶å€™</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#é—®é¢˜2-å®¢æˆ·ç«¯æ²¡æœ‰ç”¨ä¸ŠæœåŠ¡å™¨ç«¯é¢„å–çš„æ•°æ®"><span class="toc-text">é—®é¢˜2: å®¢æˆ·ç«¯æ²¡æœ‰ç”¨ä¸ŠæœåŠ¡å™¨ç«¯é¢„å–çš„æ•°æ®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#é—®é¢˜3-ç»„ä»¶çƒ­æ›´æ–°æ—¶vuex-æ¨¡å—è¢«é”€æ¯"><span class="toc-text">é—®é¢˜3: ç»„ä»¶çƒ­æ›´æ–°æ—¶ï¼ŒVuex æ¨¡å—è¢«é”€æ¯</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ç›¸å…³ä»£ç "><span class="toc-text">ç›¸å…³ä»£ç </span></a></li></ol></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://hikerpig.github.io/2018/07/03/2018-07-03-Vuex-Dynamic-Module-Hints/,HP goes FE,Vuex æ¨¡å—åŠ¨æ€æ³¨å†Œçš„ä¸€äº›å®è·µç»éªŒ,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2018/07/31/2018-07-31-Goodbye My Santa Monica Dream/" title="Goodbye My Santa Monica Dream ğŸµ" class="btn">ä¸Šä¸€ç¯‡</a></li><li class="next pagbuttons"><a role="navigation" href="/2018/05/03/2018-05-03-Try-Rust-Webassemly/" title="Try Rust WebAssembly" class="btn">ä¸‹ä¸€ç¯‡</a></li></ul></div><div id="comments"><div id="gitalk-container"></div></div><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: '0b21579fda2f1d2e73f4',
  clientSecret: 'abc0351a314cc46bb3d58b6dad62c670c2d1e8f9',
  repo: 'hikerpig.github.io',
  owner: 'hikerpig',
  admin: 'hikerpig',
  labels: ['Gitalk'],
  id: '2018/07/03/2018-07-03-Vuex-Dynamic-Module-Hints/',
  title: 'Vuex æ¨¡å—åŠ¨æ€æ³¨å†Œçš„ä¸€äº›å®è·µç»éªŒ',
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')
</script></div></div></div></div><script src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery.appear"></script><!-- Global site tag (gtag.js) - Google Analytics--><script async src="https://www.googletagmanager.com/gtag/js?id=UA-49433257-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-49433257-1');
</script><script src="https://cdn.jsdelivr.net/npm/mermaid@8.0.0/dist/mermaid.min.js"></script><script>if (window.mermaid) {
  mermaid.initialize({theme: "default"});
}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.13.1/styles/atom-one-dark.css"><script src="https://cdn.jsdelivr.net/npm/highlight.js@9.13.1/lib/highlight.js"></script><script>hljs.initHighlightingOnLoad();
</script></body></html>