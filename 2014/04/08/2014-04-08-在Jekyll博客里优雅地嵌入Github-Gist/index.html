<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="hikerpig,hikerpigwinnie@gmail.com"><title>在Jekyll博客里优雅地嵌入Github Gist · HP goes FE</title><meta name="description" content="Gist 是 Github 一个Snippet托管平台，也是全球秀代码和吵架的好地方。
例如我的一个虾米签到gist，官方提示的嵌入写法是这样的：
&amp;lt;script src=&amp;quot;https://gist.github.com/hikerpig/10013696.js&amp;quot;&amp;gt;&amp;"><meta name="keywords" content="Jekyll,Github"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/avatar.jpeg" class="sidebar__avatar"><h3 title><a href="/">HP goes FE</a></h3><div class="description"><p>Note for everything</p></div></div></div><ul class="social-links"><li><a href="http://github.com/https://github.com/hikerpig"><i class="fa fa-github"></i></a></li></ul><div class="sidebar-nav animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><a onclick="window.history.go(-1)" class="fa fa-chevron-left"></a></div></div></div><div class="footer"><a target="_blank" href="/"><span>Theme by  </span></a><a href="https://github/hikerpig">Hikerpig </a><span>forked from </span><a href="https://github.com/Ben02/hexo-theme-Anatole">Anatole</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo</a></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h1><a>在Jekyll博客里优雅地嵌入Github Gist</a></h1></div><div class="post-content"><p>Gist 是 Github 一个Snippet托管平台，也是全球秀代码和吵架的好地方。</p>
<p>例如我的一个虾米签到gist，官方提示的嵌入写法是这样的：</p>
<pre><code class="hljs text">&lt;script src=&quot;https://gist.github.com/hikerpig/10013696.js&quot;&gt;&lt;/script&gt;</code></pre>
<p>可以在markdown文档里直接插入这一句，jekyll把文章转成静态网页，用户打开后会加载。</p>
<p>不过这同步的script载入方式存在一点问题：</p>
<ol type="1">
<li><p>如果因为众所周知的某些时不时出现的“网络原因”导致此script载入失败，之后的文章内容都会停止加载的。这不，Github今天又撞墙了，以前在博客里贴的gist都挂掉了。</p></li>
<li><p>即便gist会加载成功，也有可能因为速度慢而阻碍完整文章的显示速度。</p></li>
</ol>
<p>因此，我需要一种优雅地处理gist载入失败的策略。</p>
<p>如果你不存在第1点问题，那么只要给<code>script</code>标签加上一个异步加载的属性就行：</p>
<pre><code class="hljs text">&lt;script src=&quot;https://gist.github.com/hikerpig/10013696.js&quot; async&gt;&lt;/script&gt;</code></pre>
<p>否则，就得多做点工作。</p>
<h2 id="jekyll内建模板支持">Jekyll内建模板支持</h2>
<p><a href="http://jekyllrb.com/docs/templates/#gist" target="_blank" rel="noopener">Jekyll文档</a>里说明，使用Liquid的gist标签便可插入Github Gist内容。</p>
<p>在文章里需要使用的时候，用Liquid标签包裹起来:</p>
<pre><code class="hljs text">&#123;% raw %&#125;
&#123;% gist 10013696 %&#125; 载入该gist id对应的代码片段
&#123;% gist 10013696 xiami_casper.coffee %&#125; 自定义gist显示的文件名
&#123;% gist hikerpig/10013696 xiami_casper.coffee %&#125;  私有gist
&#123;% endraw %&#125;</code></pre>
<p>看看<a href="https://github.com/jekyll/jekyll/blob/master/lib/jekyll/tags/gist.rb" target="_blank" rel="noopener">Jekyll源码里关于gist标签</a>的实现, 发现它其实，就是帮我们减少了手写script标签的苦活。在html页面中加入script标签。</p>
<pre><code class="hljs ruby"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gist_script_tag</span><span class="hljs-params">(gist_id, filename = <span class="hljs-literal">nil</span>)</span></span>
  <span class="hljs-keyword">if</span> filename.empty?
    <span class="hljs-string">"&lt;script src=\"https://gist.github.com/<span class="hljs-subst">#&#123;gist_id&#125;</span>.js\"&gt; &lt;/script&gt;"</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-string">"&lt;script src=\"https://gist.github.com/<span class="hljs-subst">#&#123;gist_id&#125;</span>.js?file=<span class="hljs-subst">#&#123;filename&#125;</span>\"&gt; &lt;/script&gt;"</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre>
<p>其实还是没法解决第1个问题.</p>
<h2 id="jekyll插件">Jekyll插件</h2>
<p><a href="http://brandontilley.com/2011/01/31/gist-tag-for-jekyll.html" target="_blank" rel="noopener">这篇文章</a>描述的插件扩展了Jekyll的gist标签。首先在_plugins文件夹里添加gist_tag.rb文件:</p>
<pre><code class="hljs ruby"><span class="hljs-keyword">require</span> <span class="hljs-string">'cgi'</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">'digest/md5'</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">'net/https'</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">'uri'</span>

<span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">Jekyll</span></span>
  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GistTag</span> &lt; Liquid::Tag</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span><span class="hljs-params">(tag_name, text, token)</span></span>
      <span class="hljs-keyword">super</span>
      @text           = text
      @cache_disabled = <span class="hljs-literal">false</span>
      @cache_folder   = File.expand_path <span class="hljs-string">"../_gist_cache"</span>, File.dirname(__FILE_<span class="hljs-number">_</span>)
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">render</span><span class="hljs-params">(context)</span></span>
      <span class="hljs-keyword">if</span> parts = @text.match(<span class="hljs-regexp">/([\d]*) (.*)/</span>)
        gist, file = parts[<span class="hljs-number">1</span>].strip, parts[<span class="hljs-number">2</span>].strip
        script_url = script_url_for gist, file
        code       = get_cached_gist(gist, file) <span class="hljs-params">||</span> get_gist_from_web(gist, file)
        html_output_for script_url, code
      <span class="hljs-keyword">else</span>
        <span class="hljs-string">""</span>
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">html_output_for</span><span class="hljs-params">(script_url, code)</span></span>
      code = CGI.escapeHTML code
      <span class="hljs-string">"&lt;script src='<span class="hljs-subst">#&#123;script_url&#125;</span>'&gt;&lt;/script&gt;&lt;noscript&gt;&lt;pre&gt;&lt;code&gt;<span class="hljs-subst">#&#123;code&#125;</span>&lt;/code&gt;&lt;/pre&gt;&lt;/noscript&gt;"</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">script_url_for</span><span class="hljs-params">(gist_id, filename)</span></span>
      <span class="hljs-string">"https://gist.github.com/<span class="hljs-subst">#&#123;gist_id&#125;</span>.js?file=<span class="hljs-subst">#&#123;filename&#125;</span>"</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_gist_url_for</span><span class="hljs-params">(gist, file)</span></span>
      <span class="hljs-string">"https://gist.github.com/raw/<span class="hljs-subst">#&#123;gist&#125;</span>/<span class="hljs-subst">#&#123;file&#125;</span>"</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cache</span><span class="hljs-params">(gist, file, data)</span></span>
      cache_file = get_cache_file_for gist, file
      File.open(cache_file, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">do</span> <span class="hljs-params">|io|</span>
        io.write data
      <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_cached_gist</span><span class="hljs-params">(gist, file)</span></span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> <span class="hljs-keyword">if</span> @cache_disabled
      cache_file = get_cache_file_for gist, file
      File.read cache_file <span class="hljs-keyword">if</span> File.exist? cache_file
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_cache_file_for</span><span class="hljs-params">(gist, file)</span></span>
      bad_chars = <span class="hljs-regexp">/[^a-zA-Z0-9\-_.]/</span>
      gist      = gist.gsub bad_chars, <span class="hljs-string">''</span>
      file      = file.gsub bad_chars, <span class="hljs-string">''</span>
      md5       = Digest::MD5.hexdigest <span class="hljs-string">"<span class="hljs-subst">#&#123;gist&#125;</span>-<span class="hljs-subst">#&#123;file&#125;</span>"</span>
      File.join @cache_folder, <span class="hljs-string">"<span class="hljs-subst">#&#123;gist&#125;</span>-<span class="hljs-subst">#&#123;file&#125;</span>-<span class="hljs-subst">#&#123;md5&#125;</span>.cache"</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_gist_from_web</span><span class="hljs-params">(gist, file)</span></span>
      gist_url          = get_gist_url_for gist, file
      raw_uri           = URI.parse gist_url
      https             = Net::HTTP.new raw_uri.host, raw_uri.port
      https.use_ssl     = <span class="hljs-literal">true</span>
      https.verify_mode = OpenSSL::SSL::VERIFY_NONE
      request           = Net::HTTP::Get.new raw_uri.request_uri
      data              = https.request request
      data              = data.body
      cache gist, file, data <span class="hljs-keyword">unless</span> @cache_disabled
      data
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GistTagNoCache</span> &lt; GistTag</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initialize</span><span class="hljs-params">(tag_name, text, token)</span></span>
      <span class="hljs-keyword">super</span>
      @cache_disabled = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

Liquid::Template.register_tag(<span class="hljs-string">'gist'</span>, Jekyll::GistTag)
Liquid::Template.register_tag(<span class="hljs-string">'gistnocache'</span>, Jekyll::GistTagNoCache)</code></pre>
<p>在每一次jekyll build的时候都去_gist_cache文件夹检查gist id是否有对应的缓存内容，没有的话会下载并保存，且在页面内添加<code>noscript</code>标签显示gist全内容，这样一来使用不支持javascript的设备也能看得到gist内容。</p>
<h2 id="js前端实现法">JS前端实现法</h2>
<p>JS界的合照狂人Ben Nadel大叔的<a href="http://www.bennadel.com/blog/2312-Loading-GitHub-Gists-After-The-Page-Content-Has-Loaded.htm" target="_blank" rel="noopener">Loading GitHub Gists After The Page Content Has Loaded</a>采取了另一种方法:</p>
<p>静态文档中用一个placeholder填在gist应该出现的位置，使用jQuery.ajax读取gist内容，数据获取完毕以后再使用document.write写到文档里。如此的前端异步载入方式可以减少后台程序生成静态页面的大小。</p>
<p>其实还是没法解决第1个问题.</p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href>http://brandontilley.com/2011/01/31/gist-tag-for-jekyll.html</a></li>
<li><a href>http://www.bennadel.com/blog/2312-Loading-GitHub-Gists-After-The-Page-Content-Has-Loaded.htm</a></li>
<li><a href="http://stackoverflow.com/questions/2082723/how-do-you-manage-your-gists-on-github" target="_blank" rel="noopener"></a></li>
</ul>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2014-04-08</span><i class="fa fa-tag"></i><a href="/categories/Meta-Blog/" title="Meta_Blog" class="tag">Meta_Blog </a><a href="/tags/Jekyll/" title="Jekyll" class="tag">Jekyll </a><a href="/tags/Github/" title="Github" class="tag">Github </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://hikerpig.github.io/2014/04/08/2014-04-08-在Jekyll博客里优雅地嵌入Github-Gist/,HP goes FE,在Jekyll博客里优雅地嵌入Github Gist,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2014/04/10/2014-04-10-用ssh-reverse-tunnel调用远程服务器的剪切板使用/" title="用 ssh reverse tunnel 调用远程服务器的剪切板使用" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2014/04/04/2014-04-04-让oh-my-zsh的gitfast插件拯救你/" title="让oh-my-zsh的git插件飞起来" class="btn">下一篇</a></li></ul></div><div id="comments"><div id="gitalk-container"></div></div><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: '0b21579fda2f1d2e73f4',
  clientSecret: 'abc0351a314cc46bb3d58b6dad62c670c2d1e8f9',
  repo: 'hikerpig.github.io',
  owner: 'hikerpig',
  admin: 'hikerpig',
  labels: ['Gitalk'],
  id: '2014/04/08/2014-04-08-在Jekyll博客里优雅地嵌入Github-Gist/',
  title: '在Jekyll博客里优雅地嵌入Github Gist',
  // facebook-like distraction free mode
  distractionFreeMode: false
})

gitalk.render('gitalk-container')
</script></div></div></div></div><script src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery.appear"></script><!-- Global site tag (gtag.js) - Google Analytics--><script async src="https://www.googletagmanager.com/gtag/js?id=UA-49433257-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-49433257-1');
</script><script src="https://cdn.jsdelivr.net/npm/mermaid@8.0.0/dist/mermaid.min.js"></script><script>if (window.mermaid) {
  mermaid.initialize({theme: "default"});
}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.13.1/styles/atom-one-dark.css"><script src="https://cdn.jsdelivr.net/npm/highlight.js@9.13.1/lib/highlight.js"></script><script>hljs.initHighlightingOnLoad();
</script></body></html>