<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="hikerpig,hikerpigwinnie@gmail.com"><title>在Jekyll博客里优雅地嵌入Github Gist · HP goes FE</title><meta name="description" content="Gist 是 Github 一个Snippet托管平台，也是全球秀代码和吵架的好地方。
例如我的一个虾米签到gist，官方提示的嵌入写法是这样的：
1&amp;lt;script src=&amp;quot;https://gist.github.com/hikerpig/10013696.js&amp;quot;&amp;gt;"><meta name="keywords" content="Front-End,Programming,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/avatar.jpeg" class="sidebar__avatar"><h3 title=""><a href="/">HP goes FE</a></h3><div class="description"><p>Note for everything</p></div></div></div><ul class="social-links"><li><a href="http://github.com/https://github.com/hikerpig"><i class="fa fa-github"></i></a></li></ul><div class="sidebar-nav animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><a onclick="window.history.go(-1)" class="fa fa-chevron-left"></a></div></div></div><div class="footer"><a target="_blank" href="/"><span>Theme by  </span></a><a href="https://github/hikerpig">Hikerpig </a><span>forked from </span><a href="https://github.com/Ben02/hexo-theme-Anatole">Anatole</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo</a></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>在Jekyll博客里优雅地嵌入Github Gist</a></h3></div><div class="post-content"><p>Gist 是 Github 一个Snippet托管平台，也是全球秀代码和吵架的好地方。</p>
<p>例如我的一个虾米签到gist，官方提示的嵌入写法是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;script src=&quot;https://gist.github.com/hikerpig/10013696.js&quot;&gt;&lt;/script&gt;</div></pre></td></tr></table></figure>
<p>可以在markdown文档里直接插入这一句，jekyll把文章转成静态网页，用户打开后会加载。</p>
<p>不过这同步的script载入方式存在一点问题：</p>
<ol style="list-style-type: decimal">
<li><p>如果因为众所周知的某些时不时出现的“网络原因”导致此script载入失败，之后的文章内容都会停止加载的。这不，Github今天又撞墙了，以前在博客里贴的gist都挂掉了。</p></li>
<li><p>即便gist会加载成功，也有可能因为速度慢而阻碍完整文章的显示速度。</p></li>
</ol>
<p>因此，我需要一种优雅地处理gist载入失败的策略。</p>
<p>如果你不存在第1点问题，那么只要给<code>script</code>标签加上一个异步加载的属性就行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;script src=&quot;https://gist.github.com/hikerpig/10013696.js&quot; async&gt;&lt;/script&gt;</div></pre></td></tr></table></figure>
<p>否则，就得多做点工作。</p>
<h2 id="jekyll内建模板支持">Jekyll内建模板支持</h2>
<p><a href="http://jekyllrb.com/docs/templates/#gist" target="_blank" rel="external">Jekyll文档</a>里说明，使用Liquid的gist标签便可插入Github Gist内容。</p>
<p>在文章里需要使用的时候，用Liquid标签包裹起来:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;% raw %&#125;</div><div class="line">&#123;% gist 10013696 %&#125; 载入该gist id对应的代码片段</div><div class="line">&#123;% gist 10013696 xiami_casper.coffee %&#125; 自定义gist显示的文件名</div><div class="line">&#123;% gist hikerpig/10013696 xiami_casper.coffee %&#125;  私有gist</div><div class="line">&#123;% endraw %&#125;</div></pre></td></tr></table></figure>
<p>看看<a href="https://github.com/jekyll/jekyll/blob/master/lib/jekyll/tags/gist.rb" target="_blank" rel="external">Jekyll源码里关于gist标签</a>的实现, 发现它其实，就是帮我们减少了手写script标签的苦活。在html页面中加入script标签。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">gist_script_tag</span><span class="params">(gist_id, filename = <span class="literal">nil</span>)</span></span></div><div class="line">  <span class="keyword">if</span> filename.empty?</div><div class="line">    <span class="string">"&lt;script src=\"https://gist.github.com/<span class="subst">#&#123;gist_id&#125;</span>.js\"&gt; &lt;/script&gt;"</span></div><div class="line">  <span class="keyword">else</span></div><div class="line">    <span class="string">"&lt;script src=\"https://gist.github.com/<span class="subst">#&#123;gist_id&#125;</span>.js?file=<span class="subst">#&#123;filename&#125;</span>\"&gt; &lt;/script&gt;"</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>其实还是没法解决第1个问题.</p>
<h2 id="jekyll插件">Jekyll插件</h2>
<p><a href="http://brandontilley.com/2011/01/31/gist-tag-for-jekyll.html" target="_blank" rel="external">这篇文章</a>描述的插件扩展了Jekyll的gist标签。首先在_plugins文件夹里添加gist_tag.rb文件:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">require</span> <span class="string">'cgi'</span></div><div class="line"><span class="keyword">require</span> <span class="string">'digest/md5'</span></div><div class="line"><span class="keyword">require</span> <span class="string">'net/https'</span></div><div class="line"><span class="keyword">require</span> <span class="string">'uri'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">module</span> <span class="title">Jekyll</span></span></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">GistTag</span> &lt; Liquid::Tag</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(tag_name, text, token)</span></span></div><div class="line">      <span class="keyword">super</span></div><div class="line">      @text           = text</div><div class="line">      @cache_disabled = <span class="literal">false</span></div><div class="line">      @cache_folder   = File.expand_path <span class="string">"../_gist_cache"</span>, File.dirname(__FILE_<span class="number">_</span>)</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">render</span><span class="params">(context)</span></span></div><div class="line">      <span class="keyword">if</span> parts = @text.match(<span class="regexp">/([\d]*) (.*)/</span>)</div><div class="line">        gist, file = parts[<span class="number">1</span>].strip, parts[<span class="number">2</span>].strip</div><div class="line">        script_url = script_url_for gist, file</div><div class="line">        code       = get_cached_gist(gist, file) <span class="params">||</span> get_gist_from_web(gist, file)</div><div class="line">        html_output_for script_url, code</div><div class="line">      <span class="keyword">else</span></div><div class="line">        <span class="string">""</span></div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">html_output_for</span><span class="params">(script_url, code)</span></span></div><div class="line">      code = CGI.escapeHTML code</div><div class="line">      <span class="string">"&lt;script src='<span class="subst">#&#123;script_url&#125;</span>'&gt;&lt;/script&gt;&lt;noscript&gt;&lt;pre&gt;&lt;code&gt;<span class="subst">#&#123;code&#125;</span>&lt;/code&gt;&lt;/pre&gt;&lt;/noscript&gt;"</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">script_url_for</span><span class="params">(gist_id, filename)</span></span></div><div class="line">      <span class="string">"https://gist.github.com/<span class="subst">#&#123;gist_id&#125;</span>.js?file=<span class="subst">#&#123;filename&#125;</span>"</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_gist_url_for</span><span class="params">(gist, file)</span></span></div><div class="line">      <span class="string">"https://gist.github.com/raw/<span class="subst">#&#123;gist&#125;</span>/<span class="subst">#&#123;file&#125;</span>"</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cache</span><span class="params">(gist, file, data)</span></span></div><div class="line">      cache_file = get_cache_file_for gist, file</div><div class="line">      File.open(cache_file, <span class="string">"w"</span>) <span class="keyword">do</span> <span class="params">|io|</span></div><div class="line">        io.write data</div><div class="line">      <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cached_gist</span><span class="params">(gist, file)</span></span></div><div class="line">      <span class="keyword">return</span> <span class="literal">nil</span> <span class="keyword">if</span> @cache_disabled</div><div class="line">      cache_file = get_cache_file_for gist, file</div><div class="line">      File.read cache_file <span class="keyword">if</span> File.exist? cache_file</div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_file_for</span><span class="params">(gist, file)</span></span></div><div class="line">      bad_chars = <span class="regexp">/[^a-zA-Z0-9\-_.]/</span></div><div class="line">      gist      = gist.gsub bad_chars, <span class="string">''</span></div><div class="line">      file      = file.gsub bad_chars, <span class="string">''</span></div><div class="line">      md5       = Digest::MD5.hexdigest <span class="string">"<span class="subst">#&#123;gist&#125;</span>-<span class="subst">#&#123;file&#125;</span>"</span></div><div class="line">      File.join @cache_folder, <span class="string">"<span class="subst">#&#123;gist&#125;</span>-<span class="subst">#&#123;file&#125;</span>-<span class="subst">#&#123;md5&#125;</span>.cache"</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_gist_from_web</span><span class="params">(gist, file)</span></span></div><div class="line">      gist_url          = get_gist_url_for gist, file</div><div class="line">      raw_uri           = URI.parse gist_url</div><div class="line">      https             = Net::HTTP.new raw_uri.host, raw_uri.port</div><div class="line">      https.use_ssl     = <span class="literal">true</span></div><div class="line">      https.verify_mode = OpenSSL::SSL::VERIFY_NONE</div><div class="line">      request           = Net::HTTP::Get.new raw_uri.request_uri</div><div class="line">      data              = https.request request</div><div class="line">      data              = data.body</div><div class="line">      cache gist, file, data <span class="keyword">unless</span> @cache_disabled</div><div class="line">      data</div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">GistTagNoCache</span> &lt; GistTag</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(tag_name, text, token)</span></span></div><div class="line">      <span class="keyword">super</span></div><div class="line">      @cache_disabled = <span class="literal">true</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">Liquid::Template.register_tag(<span class="string">'gist'</span>, Jekyll::GistTag)</div><div class="line">Liquid::Template.register_tag(<span class="string">'gistnocache'</span>, Jekyll::GistTagNoCache)</div></pre></td></tr></table></figure>
<p>在每一次jekyll build的时候都去_gist_cache文件夹检查gist id是否有对应的缓存内容，没有的话会下载并保存，且在页面内添加<code>noscript</code>标签显示gist全内容，这样一来使用不支持javascript的设备也能看得到gist内容。</p>
<h2 id="js前端实现法">JS前端实现法</h2>
<p>JS界的合照狂人Ben Nadel大叔的<a href="http://www.bennadel.com/blog/2312-Loading-GitHub-Gists-After-The-Page-Content-Has-Loaded.htm" target="_blank" rel="external">Loading GitHub Gists After The Page Content Has Loaded</a>采取了另一种方法:</p>
<p>静态文档中用一个placeholder填在gist应该出现的位置，使用jQuery.ajax读取gist内容，数据获取完毕以后再使用document.write写到文档里。如此的前端异步载入方式可以减少后台程序生成静态页面的大小。</p>
<p>其实还是没法解决第1个问题.</p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="">http://brandontilley.com/2011/01/31/gist-tag-for-jekyll.html</a></li>
<li><a href="">http://www.bennadel.com/blog/2312-Loading-GitHub-Gists-After-The-Page-Content-Has-Loaded.htm</a></li>
<li><a href="http://stackoverflow.com/questions/2082723/how-do-you-manage-your-gists-on-github" target="_blank" rel="external"></a></li>
</ul>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2015-01-28</span><i class="fa fa-tag"></i><a href="/categories/Meta-Blog/" title="Meta_Blog" class="tag">Meta_Blog </a><a href="/tags/Jekyll/" title="Jekyll" class="tag">Jekyll </a><a href="/tags/Github/" title="Github" class="tag">Github </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://hikerpig.github.io/2015/01/28/2014-04-08-在Jekyll博客里优雅地嵌入Github-Gist/,HP goes FE,在Jekyll博客里优雅地嵌入Github Gist,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2015/02/05/2014-04-22-Coffeescript小角落，和javascript混写/" title="Coffeescript小角落，和javascript混写" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2015/01/28/2014-04-29-正则也可以很好玩/" title="正则也可以很好玩" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>