<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.0dcb2fd8eb7ca1fc6efc.css">.content .gatsby-highlight{position:relative}.content .gatsby-highlight:before{content:attr(data-language);position:absolute;top:0;right:0;z-index:100;background-color:#fff;border:2px solid #f4f4f4;color:#494949;padding:.25rem .5rem;box-sizing:border-box;border-radius:0 .5rem 0 0;font-size:.875rem}:root{--toc-width:200px;--toc-normal-color:var(--link-color);--toc-hover-color:#c45612}#toc{position:fixed;right:0;z-index:100;top:80px;font-size:13px;color:var(--toc-normal-color);box-sizing:border-box;width:var(--toc-width);padding:10px 15px;text-align:left}#toc ol,#toc ul{margin-left:1em;-webkit-padding-start:0;padding-inline-start:0}#toc a,#toc a:link{color:var(--toc-normal-color);text-decoration:none}#toc a:hover,#toc a:link:hover{color:var(--toc-hover-color)}@media (max-width:899px){#toc{position:static;width:100%}}@media (--tablet){#toc{position:static;width:100%}}.post a{color:var(--link-color)}.post img:not(.inline-img){margin-left:auto;margin-right:auto}.post .inline-img{display:inline-block}a.post__title{color:inherit}:root{--timeline-node-color:grey;--timeline-line-color:#bbb;--timeline-distance:120px}.archive__posts{text-align:left;margin-bottom:20px;position:relative;line-height:2}.archive__posts a:hover .archive__item-title{transform:translateY(-2px);color:var(--link-color);text-decoration:underline}.archive__posts a:hover .archive__item-title:after{background-color:var(--link-color)}.archive__item-date{display:inline-block;width:100px}.archive__item-date:before{content:" ";width:4px;height:2em;left:var(--timeline-distance);position:absolute;background-color:var(--timeline-line-color)}.archive__item-title{display:inline-block;margin-left:3em;position:relative;transition:.3s ease}.archive__item-title:after{content:" ";width:10px;height:10px;top:.6em;left:calc(-2em + 1px);border-radius:10px;position:absolute;background-color:var(--timeline-node-color)}.archive__section-header{position:relative}.archive__section-header:before{content:" ";width:4px;height:7em;top:0;left:var(--timeline-distance);position:absolute;background-color:var(--timeline-line-color)}div.code-toolbar:focus-within>.toolbar{opacity:1}@font-face{font-family:octicons-link;src:url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAZwABAAAAAACFQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABEU0lHAAAGaAAAAAgAAAAIAAAAAUdTVUIAAAZcAAAACgAAAAoAAQAAT1MvMgAAAyQAAABJAAAAYFYEU3RjbWFwAAADcAAAAEUAAACAAJThvmN2dCAAAATkAAAABAAAAAQAAAAAZnBnbQAAA7gAAACyAAABCUM+8IhnYXNwAAAGTAAAABAAAAAQABoAI2dseWYAAAFsAAABPAAAAZwcEq9taGVhZAAAAsgAAAA0AAAANgh4a91oaGVhAAADCAAAABoAAAAkCA8DRGhtdHgAAAL8AAAADAAAAAwGAACfbG9jYQAAAsAAAAAIAAAACABiATBtYXhwAAACqAAAABgAAAAgAA8ASm5hbWUAAAToAAABQgAAAlXu73sOcG9zdAAABiwAAAAeAAAAME3QpOBwcmVwAAAEbAAAAHYAAAB/aFGpk3jaTY6xa8JAGMW/O62BDi0tJLYQincXEypYIiGJjSgHniQ6umTsUEyLm5BV6NDBP8Tpts6F0v+k/0an2i+itHDw3v2+9+DBKTzsJNnWJNTgHEy4BgG3EMI9DCEDOGEXzDADU5hBKMIgNPZqoD3SilVaXZCER3/I7AtxEJLtzzuZfI+VVkprxTlXShWKb3TBecG11rwoNlmmn1P2WYcJczl32etSpKnziC7lQyWe1smVPy/Lt7Kc+0vWY/gAgIIEqAN9we0pwKXreiMasxvabDQMM4riO+qxM2ogwDGOZTXxwxDiycQIcoYFBLj5K3EIaSctAq2kTYiw+ymhce7vwM9jSqO8JyVd5RH9gyTt2+J/yUmYlIR0s04n6+7Vm1ozezUeLEaUjhaDSuXHwVRgvLJn1tQ7xiuVv/ocTRF42mNgZGBgYGbwZOBiAAFGJBIMAAizAFoAAABiAGIAznjaY2BkYGAA4in8zwXi+W2+MjCzMIDApSwvXzC97Z4Ig8N/BxYGZgcgl52BCSQKAA3jCV8CAABfAAAAAAQAAEB42mNgZGBg4f3vACQZQABIMjKgAmYAKEgBXgAAeNpjYGY6wTiBgZWBg2kmUxoDA4MPhGZMYzBi1AHygVLYQUCaawqDA4PChxhmh/8ODDEsvAwHgMKMIDnGL0x7gJQCAwMAJd4MFwAAAHjaY2BgYGaA4DAGRgYQkAHyGMF8NgYrIM3JIAGVYYDT+AEjAwuDFpBmA9KMDEwMCh9i/v8H8sH0/4dQc1iAmAkALaUKLgAAAHjaTY9LDsIgEIbtgqHUPpDi3gPoBVyRTmTddOmqTXThEXqrob2gQ1FjwpDvfwCBdmdXC5AVKFu3e5MfNFJ29KTQT48Ob9/lqYwOGZxeUelN2U2R6+cArgtCJpauW7UQBqnFkUsjAY/kOU1cP+DAgvxwn1chZDwUbd6CFimGXwzwF6tPbFIcjEl+vvmM/byA48e6tWrKArm4ZJlCbdsrxksL1AwWn/yBSJKpYbq8AXaaTb8AAHja28jAwOC00ZrBeQNDQOWO//sdBBgYGRiYWYAEELEwMTE4uzo5Zzo5b2BxdnFOcALxNjA6b2ByTswC8jYwg0VlNuoCTWAMqNzMzsoK1rEhNqByEyerg5PMJlYuVueETKcd/89uBpnpvIEVomeHLoMsAAe1Id4AAAAAAAB42oWQT07CQBTGv0JBhagk7HQzKxca2sJCE1hDt4QF+9JOS0nbaaYDCQfwCJ7Au3AHj+LO13FMmm6cl7785vven0kBjHCBhfpYuNa5Ph1c0e2Xu3jEvWG7UdPDLZ4N92nOm+EBXuAbHmIMSRMs+4aUEd4Nd3CHD8NdvOLTsA2GL8M9PODbcL+hD7C1xoaHeLJSEao0FEW14ckxC+TU8TxvsY6X0eLPmRhry2WVioLpkrbp84LLQPGI7c6sOiUzpWIWS5GzlSgUzzLBSikOPFTOXqly7rqx0Z1Q5BAIoZBSFihQYQOOBEdkCOgXTOHA07HAGjGWiIjaPZNW13/+lm6S9FT7rLHFJ6fQbkATOG1j2OFMucKJJsxIVfQORl+9Jyda6Sl1dUYhSCm1dyClfoeDve4qMYdLEbfqHf3O/AdDumsjAAB42mNgYoAAZQYjBmyAGYQZmdhL8zLdDEydARfoAqIAAAABAAMABwAKABMAB///AA8AAQAAAAAAAAAAAAAAAAABAAAAAA==) format("woff")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .octicon{display:inline-block;vertical-align:text-top;fill:currentColor}.markdown-body a{background-color:transparent;-webkit-text-decoration-skip:objects}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body svg:not(:root){overflow:hidden}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:content-box;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px;font-weight:600}.markdown-body h2{font-size:24px;font-weight:600}.markdown-body h3{font-size:20px;font-weight:600}.markdown-body h4{font-size:16px;font-weight:600}.markdown-body h5{font-size:14px;font-weight:600}.markdown-body h6{font-size:12px;font-weight:600}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0;font:12px SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace}.markdown-body .octicon{vertical-align:text-bottom}.markdown-body .pl-0{padding-left:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:none}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body kbd{font-size:11px;border:1px solid #c6cbd1;border-bottom-color:#959da5;box-shadow:inset 0 -1px 0 #959da5}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body code{padding:.2em 0;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code:after,.markdown-body code:before{letter-spacing:-.2em;content:"\A0"}.markdown-body pre{word-wrap:normal}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code:after,.markdown-body pre code:before{content:normal}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-bottom-color:#c6cbd1;border-radius:3px;box-shadow:inset 0 -1px 0 #c6cbd1}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}.markdown-body hr{border-bottom-color:#eee}.gt-container{font-size:16px}.gt-container,.gt-container *{box-sizing:border-box}.gt-container a{color:#6190e8}.gt-container a:hover{color:#81a6ed;border-color:#81a6ed}.gt-container a.is--active{color:#333;cursor:default!important}.gt-container a.is--active:hover{color:#333}.gt-container .hide{display:none!important}.gt-container .gt-svg{display:inline-block;width:1em;height:1em;vertical-align:sub}.gt-container .gt-svg svg{width:100%;height:100%;fill:#6190e8}.gt-container .gt-ico{display:inline-block}.gt-container .gt-ico-text{margin-left:.3125em}.gt-container .gt-ico-github,.gt-container .gt-ico-github .gt-svg{width:100%;height:100%}.gt-container .gt-ico-github svg{fill:inherit}.gt-container .gt-spinner{position:relative}.gt-container .gt-spinner:before{content:"";box-sizing:border-box;position:absolute;top:3px;width:.75em;height:.75em;margin-top:-.1875em;margin-left:-.375em;border-radius:50%;border:1px solid #fff;border-top-color:#6190e8;-webkit-animation:gt-kf-rotate .6s linear infinite;animation:gt-kf-rotate .6s linear infinite}.gt-container .gt-loader{position:relative;border:1px solid #999;-webkit-animation:gt-kf-rotate 1.5s ease infinite;animation:gt-kf-rotate 1.5s ease infinite;display:inline-block;font-style:normal;width:1.75em;height:1.75em;line-height:1.75em;border-radius:50%}.gt-container .gt-loader:before{content:"";position:absolute;display:block;top:0;left:50%;margin-top:-.1875em;margin-left:-.1875em;width:.375em;height:.375em;background-color:#999;border-radius:50%}.gt-container .gt-avatar{display:inline-block;width:3.125em;height:3.125em}@media (max-width:479px){.gt-container .gt-avatar{width:2em;height:2em}}.gt-container .gt-avatar img{width:100%;height:auto;border-radius:3px}.gt-container .gt-avatar-github{width:3em;height:3em;cursor:pointer}@media (max-width:479px){.gt-container .gt-avatar-github{width:1.875em;height:1.875em}}.gt-container .gt-btn{padding:.75em 1.25em;display:inline-block;line-height:1;text-decoration:none;white-space:nowrap;cursor:pointer;border:1px solid #6190e8;border-radius:5px;background-color:#6190e8;color:#fff;outline:none;font-size:.75em}.gt-container .gt-btn-text{font-weight:400}.gt-container .gt-btn-loading{position:relative;margin-left:.5em;display:inline-block;width:.75em;height:1em;vertical-align:top}.gt-container .gt-btn.is--disable{cursor:not-allowed;opacity:.5}.gt-container .gt-btn-login{margin-right:0}.gt-container .gt-btn-preview{background-color:#fff;color:#6190e8}.gt-container .gt-btn-preview:hover{background-color:#f2f2f2;border-color:#81a6ed}.gt-container .gt-btn-public:hover{background-color:#81a6ed;border-color:#81a6ed}.gt-container .gt-error{text-align:center;margin:.625em;color:#ff3860}.gt-container .gt-initing{padding:1.25em 0;text-align:center}.gt-container .gt-initing-text{margin:.625em auto;font-size:92%}.gt-container .gt-no-init{padding:1.25em 0;text-align:center}.gt-container .gt-link{border-bottom:1px dotted #6190e8}.gt-container .gt-link-counts,.gt-container .gt-link-project{text-decoration:none}.gt-container .gt-meta{margin:1.25em 0;padding:1em 0;border-bottom:1px solid #e9e9e9;font-size:1em;position:relative;z-index:10}.gt-container .gt-meta:after,.gt-container .gt-meta:before{content:" ";display:table}.gt-container .gt-meta:after{clear:both}.gt-container .gt-counts{margin:0 .625em 0 0}.gt-container .gt-user{float:right;margin:0;font-size:92%}.gt-container .gt-user-pic{width:16px;height:16px;vertical-align:top;margin-right:.5em}.gt-container .gt-user-inner{display:inline-block;cursor:pointer}.gt-container .gt-user .gt-ico{margin:0 0 0 .3125em}.gt-container .gt-user .gt-ico svg{fill:inherit}.gt-container .gt-user .is--poping .gt-ico svg{fill:#6190e8}.gt-container .gt-version{color:#a1a1a1;margin-left:.375em}.gt-container .gt-copyright{margin:0 .9375em .5em;border-top:1px solid #e9e9e9;padding-top:.5em}.gt-container .gt-popup{position:absolute;right:0;top:2.375em;background:#fff;display:inline-block;border:1px solid #e9e9e9;padding:.625em 0;font-size:.875em;letter-spacing:.5px}.gt-container .gt-popup .gt-action{cursor:pointer;display:block;margin:.5em 0;padding:0 1.125em;position:relative;text-decoration:none}.gt-container .gt-popup .gt-action.is--active:before{content:"";width:.25em;height:.25em;background:#6190e8;position:absolute;left:.5em;top:.4375em}.gt-container .gt-header{position:relative;display:flex}.gt-container .gt-header-comment{flex:1;margin-left:1.25em}@media (max-width:479px){.gt-container .gt-header-comment{margin-left:.875em}}.gt-container .gt-header-textarea{padding:.75em;display:block;box-sizing:border-box;width:100%;min-height:5.125em;max-height:15em;border-radius:5px;border:1px solid rgba(0,0,0,.1);font-size:.875em;word-wrap:break-word;resize:vertical;background-color:#f6f6f6;outline:none;transition:all .25s ease}.gt-container .gt-header-textarea:hover{background-color:#fbfbfb}.gt-container .gt-header-preview{padding:.75em;border-radius:5px;border:1px solid rgba(0,0,0,.1);background-color:#f6f6f6}.gt-container .gt-header-controls{position:relative;margin:.75em 0 0}.gt-container .gt-header-controls:after,.gt-container .gt-header-controls:before{content:" ";display:table}.gt-container .gt-header-controls:after{clear:both}@media (max-width:479px){.gt-container .gt-header-controls{margin:0}}.gt-container .gt-header-controls-tip{font-size:.875em;color:#6190e8;text-decoration:none;vertical-align:sub}@media (max-width:479px){.gt-container .gt-header-controls-tip{display:none}}.gt-container .gt-header-controls .gt-btn{float:right;margin-left:1.25em}@media (max-width:479px){.gt-container .gt-header-controls .gt-btn{float:none;width:100%;margin:.75em 0 0}}.gt-container:after{content:"";position:fixed;bottom:100%;left:0;right:0;top:0;opacity:0}.gt-container.gt-input-focused{position:relative}.gt-container.gt-input-focused:after{content:"";position:fixed;bottom:0;left:0;right:0;top:0;background:#000;opacity:.6;transition:opacity .3s,bottom 0s;z-index:9999}.gt-container.gt-input-focused .gt-header-comment{z-index:10000}.gt-container .gt-comments{padding-top:1.25em}.gt-container .gt-comments-null{text-align:center}.gt-container .gt-comments-controls{margin:1.25em 0;text-align:center}.gt-container .gt-comment{position:relative;padding:.625em 0;display:flex}.gt-container .gt-comment-content{flex:1;margin-left:1.25em;padding:.75em 1em;background-color:#f9f9f9;overflow:auto;transition:all .25s ease}.gt-container .gt-comment-content:hover{box-shadow:0 .625em 3.75em 0 #f4f4f4}@media (max-width:479px){.gt-container .gt-comment-content{margin-left:.875em;padding:.625em .75em}}.gt-container .gt-comment-header{margin-bottom:.5em;font-size:.875em;position:relative}.gt-container .gt-comment-block-1{float:right;height:1.375em;width:2em}.gt-container .gt-comment-block-2{float:right;height:1.375em;width:4em}.gt-container .gt-comment-username{font-weight:500;color:#6190e8;text-decoration:none}.gt-container .gt-comment-username:hover{text-decoration:underline}.gt-container .gt-comment-date,.gt-container .gt-comment-text{margin-left:.5em;color:#a1a1a1}.gt-container .gt-comment-edit,.gt-container .gt-comment-like,.gt-container .gt-comment-reply{position:absolute;height:1.375em}.gt-container .gt-comment-edit:hover,.gt-container .gt-comment-like:hover,.gt-container .gt-comment-reply:hover{cursor:pointer}.gt-container .gt-comment-like{top:0;right:2em}.gt-container .gt-comment-edit,.gt-container .gt-comment-reply{top:0;right:0}.gt-container .gt-comment-body{color:#333!important}.gt-container .gt-comment-body .email-hidden-toggle a{display:inline-block;height:12px;padding:0 9px;font-size:12px;font-weight:600;line-height:6px;color:#444d56;text-decoration:none;vertical-align:middle;background:#dfe2e5;border-radius:1px}.gt-container .gt-comment-body .email-hidden-toggle a:hover{background-color:#c6cbd1}.gt-container .gt-comment-body .email-hidden-reply{display:none;white-space:pre-wrap}.gt-container .gt-comment-body .email-hidden-reply .email-signature-reply{padding:0 15px;margin:15px 0;color:#586069;border-left:4px solid #dfe2e5}.gt-container .gt-comment-body .email-hidden-reply.expanded{display:block}.gt-container .gt-comment-admin .gt-comment-content{background-color:#f6f9fe}@-webkit-keyframes gt-kf-rotate{0%{transform:rotate(0)}to{transform:rotate(1turn)}}@keyframes gt-kf-rotate{0%{transform:rotate(0)}to{transform:rotate(1turn)}}.icon-module--root--aZeph{display:inline-flex;align-items:center;justify-content:center}.icon-module--icon--1ihz7{fill:currentColor}.icon-module--label--fHC-f{position:relative;display:inline-block;margin-left:4px;line-height:1}.menu-module--mobileMenuContainer--T9wTN{display:none}@media (max-width:683px){.menu-module--mobileMenuContainer--T9wTN{display:flex}}@media (--phone){.menu-module--mobileMenuContainer--T9wTN{display:flex}}.menu-module--desktopMenuContainer--3iXKR{display:block}@media (max-width:683px){.menu-module--desktopMenuContainer--3iXKR{display:none}}@media (--phone){.menu-module--desktopMenuContainer--3iXKR{display:none}}.menu-module--menu--dd4-Y{display:flex;flex:0 0 auto;align-items:center;justify-content:flex-start;max-width:100%;padding:0 15px;list-style:none;border-right:1px solid;margin:0 18px 0 auto}.menu-module--menu--dd4-Y li{margin:0 12px}.menu-module--menuTrigger--32seM{margin-right:10px;padding:0;line-height:0;background:none;color:inherit;border:none;box-shadow:none;outline:none;-webkit-appearance:none;-moz-appearance:none;appearance:none;cursor:pointer}.menu-module--menu--dd4-Y a{display:inline-block;margin-right:15px;text-decoration:none}.menu-module--menu--dd4-Y a:last-of-type{margin-right:0}.menu-module--menu--dd4-Y a:hover{opacity:.6}.menu-module--mobileMenu--2VGmR{position:absolute;top:0;right:0;flex-direction:column;align-items:flex-start;background:#fafafa;margin:0;padding:0;text-align:left;list-style:none;border-radius:5px;overflow:hidden;z-index:99}.dark-theme .menu-module--mobileMenu--2VGmR{background:#252627}.menu-module--mobileMenu--2VGmR li{margin:0;white-space:nowrap}.menu-module--mobileMenu--2VGmR li a{display:block;padding:10px 15px}.menu-module--mobileMenuOverlay--2RcSs{position:fixed;top:0;bottom:0;left:0;right:0;background:rgba(0,0,0,.2);z-index:10}.menu-module--themeToggle--2E8ye{line-height:0;padding:0 5px}.menu-module--subMenuTrigger--1crdm,.menu-module--themeToggle--2E8ye{background:none;color:inherit;border:none;box-shadow:none;-webkit-appearance:none;-moz-appearance:none;appearance:none;outline:none}.menu-module--subMenuTrigger--1crdm{font-size:inherit;font-weight:inherit;margin:0 12px;padding:0;cursor:pointer}.menu-module--subMenu--3Rgj_{position:absolute;max-width:300px;background:#fafafa;box-shadow:0 8px 20px rgba(0,0,0,.12);margin:0;padding:5px;list-style:none;border-radius:5px;top:35px;right:70px;overflow:hidden;z-index:99}.dark-theme .menu-module--subMenu--3Rgj_{background:var(--dark-background-secondary)}.menu-module--subMenu--3Rgj_ li{text-align:left;margin:0;white-space:nowrap}.menu-module--subMenu--3Rgj_ li a{padding:10px}.menu-module--subMenu--3Rgj_ li:hover{background:rgba(0,0,0,.05);border-radius:3px;cursor:pointer}.dark-theme .menu-module--subMenu--3Rgj_ li:hover{background:rgba(0,0,0,.15)}.menu-module--subMenuOverlay--3TQRy{position:fixed;top:0;bottom:0;left:0;right:0;z-index:-1}.menu-module--menuArrow--1COMf{display:inline-block;font-family:-apple-system,BlinkMacSystemFont,Roboto,Segoe UI,Helvetica,Arial,sans-serif;margin-left:5px;transform:rotate(90deg)}.header-module--header--tFeG9{background:#fafafa;display:flex;align-items:center;justify-content:space-between;position:relative;padding:20px}.dark-theme .header-module--header--tFeG9{background:#252627}.header-module--header--tFeG9 a{text-decoration:none}.header-module--inner--7ao1M{justify-content:space-between;margin:0 auto;width:100%}.header-module--inner--7ao1M,.header-module--logo--2kX-3{display:flex;align-items:center}.header-module--logo--2kX-3{text-decoration:none;font-weight:700}.header-module--logo--2kX-3 img{height:26px;border-radius:100%;transform:translateX(-100px);transition:.3s ease}.header-module--logo--2kX-3:hover img{transform:translateX(0);margin-right:8px}.header-module--mark--J6C0c{margin-right:5px}.header-module--mark--J6C0c,.header-module--text--3UAQj{font-size:18px}.header-module--right--1Zeb6{display:flex;position:relative}@-webkit-keyframes header-module--cursor--33Aoa{0%{opacity:0}50%{opacity:1}to{opacity:0}}@keyframes header-module--cursor--33Aoa{0%{opacity:0}50%{opacity:1}to{opacity:0}}:root{--light-background:#fcfcfc;--light-background-secondary:#eaeaea;--light-color:#222;--light-color-secondary:#999;--light-border-color:#dcdcdc;--dark-background:#292a2d;--dark-background-secondary:#3b3d42;--dark-color:#a9a9b3;--dark-color-secondary:#73747b;--dark-border-color:#4a4b50;--link-color:#ff766d;--phoneWidth:(max-width:684px);--tabletWidth:(max-width:900px)}@custom-media --phone (max-width: 683px);@custom-media --tablet (max-width: 899px);pre[class*=language-],pre[class*=language-]>code{color:#a9a9b3;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;background:#1a1a1d!important;border-radius:8px}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:hsla(0,0%,100%,.35)}.token.punctuation{color:#a9a9b3}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}pre[class*=language-].line-numbers{position:relative;padding-left:65px;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:5px!important;width:3em!important;letter-spacing:-1px;border-right:1px solid;opacity:.5;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}div.code-toolbar{position:relative}div.code-toolbar>.toolbar{position:absolute;top:.3em;right:.2em;transition:opacity .3s ease-in-out;opacity:0}div.code-toolbar:hover>.toolbar{opacity:1}div.code-toolbar>.toolbar .toolbar-item{display:inline-block}div.code-toolbar>.toolbar a{cursor:pointer}div.code-toolbar>.toolbar button{background:none;border:0;color:inherit;font:inherit;line-height:normal;overflow:visible;padding:0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}div.code-toolbar>.toolbar a,div.code-toolbar>.toolbar button,div.code-toolbar>.toolbar span{color:#bbb;font-size:.8em;padding:0 .5em;background:#f5f2f0;background:hsla(0,0%,87.8%,.2);box-shadow:0 2px 0 0 rgba(0,0,0,.2);border-radius:.5em}div.code-toolbar>.toolbar a:focus,div.code-toolbar>.toolbar a:hover,div.code-toolbar>.toolbar button:focus,div.code-toolbar>.toolbar button:hover,div.code-toolbar>.toolbar span:focus,div.code-toolbar>.toolbar span:hover{color:inherit;text-decoration:none}.command-line-prompt{border-right:1px solid #999;display:block;float:left;font-size:100%;letter-spacing:-1px;margin-right:1em;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.command-line-prompt>span:before{color:#999;content:" ";display:block;padding-right:.8em}.command-line-prompt>span[data-user]:before{content:"[" attr(data-user) "@" attr(data-host) "] $"}.command-line-prompt>span[data-user=root]:before{content:"[" attr(data-user) "@" attr(data-host) "] #"}.command-line-prompt>span[data-prompt]:before{content:attr(data-prompt)}html{box-sizing:border-box}*,:after,:before{box-sizing:inherit}body{margin:0;padding:0;font-family:Noto Sans SC,-apple-system,BlinkMacSystemFont,Roboto,Segoe UI,Helvetica,Arial,sans-serif;font-size:1rem;line-height:1.54;background-color:var(--light-background);color:var(--light-color);text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;font-feature-settings:"liga","tnum","case","calt","zero","ss01","locl";-webkit-overflow-scrolling:touch;-webkit-text-size-adjust:100%}@media (max-width:683px){body{font-size:1rem}}@media (--phone){body{font-size:1rem}}body.dark-theme{background-color:var(--dark-background);color:var(--dark-color)}h1,h2,h3,h4,h5,h6{display:flex;align-items:center;line-height:1.3}h1{font-size:2}h2{font-size:1.625rem}h3{font-size:1.375rem}h4{font-size:1.125rem}@media (max-width:683px){h1{font-size:1.8rem}h2{font-size:1.4rem}h3{font-size:1.15rem}h4{font-size:1.125rem}}@media (--phone){h1{font-size:1.8rem}h2{font-size:1.4rem}h3{font-size:1.15rem}h4{font-size:1.125rem}}a{color:inherit}img{display:block;max-width:100%}img.center,img.left{margin-right:auto}img.center,img.right{margin-left:auto}figure{display:table;max-width:100%;margin:25px 0}figure.center,figure.left{margin-right:auto}figure.center,figure.right{margin-left:auto}figure figcaption{font-size:14px;margin-top:5px;opacity:.8}figure figcaption.left{text-align:left}figure figcaption.center{text-align:center}figure figcaption.right{text-align:right}code{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-feature-settings:normal;font-weight:400;background:var(--light-background-secondary);padding:1px 6px;margin:0 2px;border-radius:5px;font-size:.9rem}.dark-theme code{background:var(--dark-background-secondary)}pre{background:#1a1a1d;padding:20px;border-radius:8px;font-size:.9rem;overflow:auto}@media (max-width:683px){pre{white-space:pre-wrap;word-wrap:break-word}}@media (--phone){pre{white-space:pre-wrap;word-wrap:break-word}}pre code{background:none!important;color:#ccc;margin:0;padding:0;font-size:.9rem}blockquote{border-left:2px solid;margin:40px;padding:10px 20px}@media (max-width:683px){blockquote{margin:10px;padding:10px}}@media (--phone){blockquote{margin:10px;padding:10px}}blockquote p:first-of-type{margin-top:0}blockquote p:last-of-type{margin-bottom:0}table{table-layout:fixed;border-collapse:collapse;width:100%;margin:40px 0;border-radius:5px}table,td,th{border:1px solid var(--light-color);padding:10px}.dark-theme table,.dark-theme td,.dark-theme th{border-color:var(--dark-color)}th{background:var(--light-background-secondary)}.dark-theme th{background:var(--dark-background-secondary)}ol,ul{margin-left:40px;padding:0}@media (max-width:683px){ol,ul{margin-left:20px}}@media (--phone){ol,ul{margin-left:20px}}ol ol{list-style-type:lower-alpha}button,input,textarea{font-family:Noto Sans SC,-apple-system,BlinkMacSystemFont,Roboto,Segoe UI,Helvetica,Arial,sans-serif}.container{flex-direction:column;text-align:center}.container,.content{display:flex;justify-content:center}.content{flex-direction:column;flex:1 0 auto;align-items:center;margin:20px auto;width:100%;max-width:900px}@media (max-width:683px){.content{margin-top:0}}@media (--phone){.content{margin-top:0}}@media (max-width:899px){.content{max-width:660px}}@media (--tablet){.content{max-width:660px}}hr{width:100%;border:none;background:var(--light-border-color);height:1px}.dark-theme hr{background:var(--dark-border-color)}.infoBanner{text-align:left;margin:20px 0 40px;padding:10px 20px;border-radius:10px;width:calc(100% - 40px);background:var(--light-background-secondary)}.dark-theme .infoBanner{background:var(--dark-background-secondary)}.infoBanner span{font-weight:700}.hidden{display:none}.embedVideo-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden}.embedVideo-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0}footer{font-size:1rem;text-align:center;margin-bottom:50px}@media (max-width:683px){footer{display:flex;flex-direction:column}}@media (--phone){footer{display:flex;flex-direction:column}}footer .footerCopyrights:not(:first-of-type){margin-left:20px;padding-left:20px;border-left:1px solid}@media (max-width:683px){footer .footerCopyrights:not(:first-of-type){margin:0;padding:0;border:none}}@media (--phone){footer .footerCopyrights:not(:first-of-type){margin:0;padding:0;border:none}}.navigation-module--navigation--3Zfju{display:flex;width:1024px;max-width:100%;margin:80px 0 40px}.navigation-module--button--28kp3,.navigation-module--navigation--3Zfju{align-items:center;justify-content:center}.navigation-module--button--28kp3{position:relative;display:inline-flex;background:var(--light-background-secondary);font-size:1rem;font-weight:700;border-radius:8px;max-width:40%;cursor:pointer;-webkit-appearance:none;-moz-appearance:none;appearance:none}.dark-theme .navigation-module--button--28kp3{background:var(--dark-background-secondary)}.navigation-module--button--28kp3+.navigation-module--button--28kp3{margin-left:10px}.navigation-module--button--28kp3 a{display:flex;padding:8px 16px;text-decoration:none}.navigation-module--button--28kp3 a,.navigation-module--buttonText--1Xod2{text-overflow:ellipsis;white-space:nowrap;overflow:hidden}.navigation-module--iconNext--3xyJ-{margin-left:8px}.navigation-module--iconPrev--23mg1{margin-right:8px}.post-module--post--28Mq2{width:100%;max-width:900px;text-align:left;padding:20px;margin:0 auto 20px}.post-module--post--28Mq2:not(:last-of-type){border-bottom:1px solid var(--light-border-color)}.dark-theme .post-module--post--28Mq2:not(:last-of-type){border-color:var(--dark-border-color)}@media (max-width:899px){.post-module--post--28Mq2{max-width:660px}}@media (--tablet){.post-module--post--28Mq2{max-width:660px}}.post-module--post--28Mq2 h1{margin:0 0 10px}.post-module--post--28Mq2 img{border-radius:8px}.post-module--title--3XBo2 a{text-decoration:none}.post-module--coverImage--1GM7V{border-radius:8px;margin-bottom:40px;box-shadow:0 15px 30px rgba(0,0,0,.1)}.post-module--meta--3YtjE{font-size:1rem;margin-bottom:15px}.post-module--tags--3RbqF{margin-top:10px;opacity:.5}.post-module--tag--16U9p{margin-right:10px}.post-module--readMore--3zWML,.post-module--tag--16U9p{display:inline-block}.post-module--readMore--3zWML{text-decoration:none;font-weight:700;margin-top:20px;font-size:1rem}.post-module--postContent--1bfnt{position:relative}</style><meta name="generator" content="Gatsby 2.24.84"/><title data-react-helmet="true">Decode Video Using ffmpeg In Browser :: HP goes FE</title><link data-react-helmet="true" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&amp;display=swap" rel="stylesheet"/><meta data-react-helmet="true" name="description" content="音视频开发入门，可能绕不开 ffmpeg 这个项目，最近看了篇 知乎专栏，觉得这个事情很有意思。 比起直接编辑整个 ffmpeg 项目的 CLI 到前端，更符合实际需求的方式，是先基于 ffmpeg 各种 lib…"/><meta data-react-helmet="true" property="og:title" content="Decode Video Using ffmpeg In Browser"/><meta data-react-helmet="true" property="og:description" content="音视频开发入门，可能绕不开 ffmpeg 这个项目，最近看了篇 知乎专栏，觉得这个事情很有意思。 比起直接编辑整个 ffmpeg 项目的 CLI 到前端，更符合实际需求的方式，是先基于 ffmpeg 各种 lib…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="Decode Video Using ffmpeg In Browser"/><meta data-react-helmet="true" name="twitter:description" content="音视频开发入门，可能绕不开 ffmpeg 这个项目，最近看了篇 知乎专栏，觉得这个事情很有意思。 比起直接编辑整个 ffmpeg 项目的 CLI 到前端，更符合实际需求的方式，是先基于 ffmpeg 各种 lib…"/><meta data-react-helmet="true" name="twitter:creator" content="@hikerpig"/><meta data-react-helmet="true" name="keywords" content="gatsby, minimal, starter, blog, theme, dark, light, personal site"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="/favicon-32x32.png?v=010f7f2435f789857c3869d667cf9d0c" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#ff766d"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=010f7f2435f789857c3869d667cf9d0c"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=010f7f2435f789857c3869d667cf9d0c"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=010f7f2435f789857c3869d667cf9d0c"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=010f7f2435f789857c3869d667cf9d0c"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=010f7f2435f789857c3869d667cf9d0c"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=010f7f2435f789857c3869d667cf9d0c"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=010f7f2435f789857c3869d667cf9d0c"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=010f7f2435f789857c3869d667cf9d0c"/><link as="script" rel="preload" href="/webpack-runtime-b89597f0e82278f0e44d.js"/><link as="script" rel="preload" href="/framework-fc9659a3b74fac5c7369.js"/><link as="script" rel="preload" href="/app-1d0336bfb45b291984c0.js"/><link as="script" rel="preload" href="/styles-407fe62976dc5310c43e.js"/><link as="script" rel="preload" href="/commons-54da21bc01fa6cc2b833.js"/><link as="script" rel="preload" href="/23c3d3a3a2879427593569aafa02d04d4d5b9e2a-dcd5761da3e45fbc9bc8.js"/><link as="script" rel="preload" href="/component---src-templates-page-js-77b515186c30c4b9f999.js"/><link as="fetch" rel="preload" href="/page-data/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1425477374.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3128451518.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body class="dark-theme"><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="container"><header class="header-module--header--tFeG9"><div class="header-module--inner--7ao1M"><a href="/"><div class="header-module--logo--2kX-3"><img src="/logo.png" alt="Hikerpig 万事记"/><span class="header-module--mark--J6C0c">&gt;</span><span class="header-module--text--3UAQj">HP goes FE</span></div></a><span class="header-module--right--1Zeb6"><div class="menu-module--mobileMenuContainer--T9wTN"><button class="menu-module--menuTrigger--32seM" style="color:inherit" type="button" aria-label="Menu"><span class="icon-module--root--aZeph" style="cursor:pointer" role="figure"><svg version="1.1" width="24" height="24" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M4 34H40V30H4V34ZM4 24H40V20H4V24ZM4 10V14H40V10H4Z" class="icon-module--icon--1ihz7"></path></svg></span></button></div><div class="menu-module--desktopMenuContainer--3iXKR"><ul class="menu-module--menu--dd4-Y"><li><a href="/about">About</a></li><li><a href="/archives">归档</a></li></ul></div><button class="menu-module--themeToggle--2E8ye" type="button" aria-label="Theme toggle"><span class="icon-module--root--aZeph" style="cursor:pointer" role="figure"><svg version="1.1" width="24" height="24" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z" class="icon-module--icon--1ihz7"></path></svg></span></button></span></div></header><div class="content"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-themes/themes/prism-vsc-dark-plus.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/><div id="toc"><div><ul>
<li><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#web-demo-%E5%BA%94%E7%94%A8%E6%B5%81%E7%A8%8B">Web demo 应用流程</a></li>
<li>
<p><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#%E4%BB%8E%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91-ffmpeg">从源码编译 ffmpeg</a></p>
<ul>
<li><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#%E9%A1%B9%E7%9B%AE-makefile">项目 Makefile</a></li>
</ul>
</li>
<li>
<p><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#%E7%BC%96%E8%AF%91%E5%92%8C%E4%BD%BF%E7%94%A8">编译和使用</a></p>
<ul>
<li><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#%E7%94%9F%E6%88%90-js-%E5%92%8C-wasm-%E6%96%87%E4%BB%B6">生成 JS 和 WASM 文件</a></li>
<li>
<p><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95">使用方法</a></p>
<ul>
<li><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90">简单的例子</a></li>
<li><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#%E7%A8%8D%E5%BE%AE%E5%A4%8D%E6%9D%82%E7%82%B9%E7%9A%84%E4%BE%8B%E5%AD%90">稍微复杂点的例子</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#%E4%B8%80%E4%BA%9B%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E7%9A%84%E4%BB%A3%E7%A0%81">一些具体实现的代码</a></p>
<ul>
<li><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#js-%E5%B0%86%E8%A7%86%E9%A2%91%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5-wasm-%E7%BA%BF%E6%80%A7%E5%86%85%E5%AD%98">JS 将视频数据写入 WASM 线性内存</a></li>
<li><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#c-%E7%A8%8B%E5%BA%8F%E5%A4%B4%E9%83%A8">C 程序头部</a></li>
<li><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#c-avcodec-%E8%A7%A3%E6%9E%90%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6">C avcodec 解析视频文件</a></li>
<li><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#c-%E8%8E%B7%E5%8F%96%E5%9B%BE%E7%89%87-rgb-%E6%95%B0%E6%8D%AE">C 获取图片 rgb 数据</a></li>
<li><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#c-%E5%B0%86%E5%9B%BE%E5%83%8F%E7%AD%89%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98">C 将图像等数据写入内存</a></li>
<li><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#js-%E6%A0%B9%E6%8D%AE%E6%8C%87%E9%92%88%E8%AF%BB%E5%87%BA%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%9E%84%E5%BB%BA-imagedata">JS 根据指针读出数据，构建 ImageData</a></li>
</ul>
</li>
<li><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#%E6%80%BB%E7%BB%93">总结</a></li>
<li><a href="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/#%E5%8F%82%E8%80%83">参考</a></li>
</ul></div></div><div class="post-module--post--28Mq2 post"><div class="post-module--postContent--1bfnt"><h1 class="post-module--title--3XBo2">Decode Video Using ffmpeg In Browser</h1><div class="post-module--meta--3YtjE">2019-03-06<!-- --> <div class="post-module--tags--3RbqF"><a href="/tag/Webassembly/"><span class="post-module--tag--16U9p">#<!-- -->Webassembly</span></a><a href="/tag/Avtech/"><span class="post-module--tag--16U9p">#<!-- -->Avtech</span></a><a href="/tag/Emscripten/"><span class="post-module--tag--16U9p">#<!-- -->Emscripten</span></a><a href="/tag/ffmpeg/"><span class="post-module--tag--16U9p">#<!-- -->ffmpeg</span></a></div></div><div><p>音视频开发入门，可能绕不开 ffmpeg 这个项目，最近看了篇 <a href="https://zhuanlan.zhihu.com/p/40786748">知乎专栏</a>，觉得这个事情很有意思。</p>
<p>比起直接编辑整个 ffmpeg 项目的 CLI 到前端，更符合实际需求的方式，是先基于 ffmpeg 各种 lib 二次开发出合适的功能，此时结果是可执行的二进制文件，可以用 lldb 或者 gdb 调试。然后再使用 Emscripten 编译到 Webassembly，如此一来可以解决 wasm 不易调试的问题。</p>
<p>跟着教程实现一个功能：解析出视频任意一帧的图像并绘制到 canvas 上。</p>
<h2 id="web-demo-应用流程" style="position:relative;"><a href="#web-demo-%E5%BA%94%E7%94%A8%E6%B5%81%E7%A8%8B" aria-label="web demo 应用流程 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Web demo 应用流程</h2>
<p>demo 页的简单流程</p>
<div class="mermaid">graph TD
    P1[获取视频 buffer 并写入wasm将要使用的线性内存空间] -- 进入wasm调用 --> A

subgraph C 程序转成的 wasm
    A[avcodec 解析视频文件 buffer] --> B[解出指定时间的图像并转成 RGB 格式数据]
    B --> C[将图像等数据写入内存, 并将指针返给 js 端]
end

    C  -- 回到 js -->  D[根据指针读出数据, 构建 ImageData, 绘制到 canvas 上]</div>
<h2 id="从源码编译-ffmpeg" style="position:relative;"><a href="#%E4%BB%8E%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91-ffmpeg" aria-label="从源码编译 ffmpeg permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>从源码编译 ffmpeg</h2>
<p>本文写就的时候使用的是 ffmpeg <code>n4.2-dev</code> 版，将其源码置于项目相对目录 <code>lib/ffmpeg</code> 下。</p>
<p>ffmpeg 是一个很大的项目，包含的很多功能对于我们的需求来说，都用不上，可以通过 <a href="https://github.com/FFmpeg/FFmpeg/blob/master/configure">configure</a> 配置留下合适的功能集。这个其实就是一个可执行的 sh 脚本，比较复杂的项目，通常在实际编译之前，可以使用 configure 根据参数和环境生成实际编译过程需要的 Makefile。</p>
<h3 id="项目-makefile" style="position:relative;"><a href="#%E9%A1%B9%E7%9B%AE-makefile" aria-label="项目 makefile permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>项目 Makefile</h3>
<p>参考 <a href="https://github.com/Kagami/ffmpeg.js/">ffmpeg.js</a> 项目的一些配置</p>
<div class="gatsby-highlight" data-language="makefile"><pre class="language-makefile"><code class="language-makefile">COMMON_FILTERS <span class="token operator">=</span> scale crop overlay
COMMON_DEMUXERS <span class="token operator">=</span> matroska ogg avi mov flv mpegps image2 mp3 concat
COMMON_DECODERS <span class="token operator">=</span> \
	mpeg2video mpeg4 h264 hevc \
	png mjpeg \
	mp3 ac3 aac

MUXERS <span class="token operator">=</span> mp4 null image2
ENCODERS <span class="token operator">=</span> mjpeg

FFMPEG_CONFIGURE_ARGS <span class="token operator">=</span> \
	--cc<span class="token operator">=</span>emcc \
	--ar<span class="token operator">=</span>emar \
	--enable-cross-compile \
	--target-os<span class="token operator">=</span>none \
	--cpu<span class="token operator">=</span>generic \
	--arch<span class="token operator">=</span>x86 \
	--disable-runtime-cpudetect \
	--disable-asm \
	--disable-fast-unaligned \
	--disable-pthreads \
	--disable-w32threads \
	--disable-os2threads \
	--disable-debug \
	--disable-stripping \
	\
	--disable-all \
	--enable-avcodec \
	--enable-avformat \
	--enable-avutil \
	--enable-swscale \
	--enable-shared \
	--enable-protocol<span class="token operator">=</span>file \
	<span class="token variable">$</span><span class="token punctuation">(</span>addprefix --enable-decoder<span class="token operator">=</span>,<span class="token variable">$</span><span class="token punctuation">(</span>COMMON_DECODERS<span class="token punctuation">)</span><span class="token punctuation">)</span> \
	<span class="token variable">$</span><span class="token punctuation">(</span>addprefix --enable-demuxer<span class="token operator">=</span>,<span class="token variable">$</span><span class="token punctuation">(</span>COMMON_DEMUXERS<span class="token punctuation">)</span><span class="token punctuation">)</span> \
	<span class="token variable">$</span><span class="token punctuation">(</span>addprefix --enable-encoder<span class="token operator">=</span>,<span class="token variable">$</span><span class="token punctuation">(</span>ENCODERS<span class="token punctuation">)</span><span class="token punctuation">)</span> \
	<span class="token variable">$</span><span class="token punctuation">(</span>addprefix --enable-muxer<span class="token operator">=</span>,<span class="token variable">$</span><span class="token punctuation">(</span>MUXERS<span class="token punctuation">)</span><span class="token punctuation">)</span> \
	<span class="token variable">$</span><span class="token punctuation">(</span>addprefix --enable-filter<span class="token operator">=</span>,<span class="token variable">$</span><span class="token punctuation">(</span>COMMON_FILTERS<span class="token punctuation">)</span><span class="token punctuation">)</span> 

<span class="token comment"># to run ffmpeg configure and emmake</span>
<span class="token symbol">lib/ffmpeg/libavcodec/libavcodec.a</span><span class="token punctuation">:</span>
	cd lib/ffmpeg &amp;&amp; \
	patch -p1 &lt; ../swscale.c.patch &amp;&amp; \
	emconfigure ./configure \
		<span class="token variable">$</span><span class="token punctuation">(</span>FFMPEG_CONFIGURE_ARGS<span class="token punctuation">)</span> \
		&amp;&amp; \
	emmake make</code></pre></div>
<p>说下 <code>lib/ffmpeg/libavcodec/libavcodec.a</code> 这个目标，分成几步:</p>
<ul>
<li><code>emconfigure</code> 是 emsdk 提供的工具，执行完这一步之后，会生成 <code>lib/ffmpeg/Makefile</code></li>
<li><code>emmake make</code> 便是开始编译了，由于我们在前一步 configure 的时候有 <code>--enable-avcodec</code>，所以用这个 Makefile 编译，会生成 <code>lib/ffmpeg/libavcodec/libavcodec.a</code> 这个静态库文件</li>
<li>编译原本的 ffmpeg 代码会报错，定位到 <code>libswscale/swscale.c</code> 文件里，为了编译通过，在编译前加了个不影响主要功能的简单的 patch</li>
</ul>
<p>运行 <code>make lib/ffmpeg/libavcodec/libavcodec.a</code>，等待大约一两分钟，emscripten 编译 ffmpeg 静态库完成，闪过了一堆 warning 可以优雅地无视掉。接下来就是编写我们的应用接口代码并编译到 WebAssembly 了。</p>
<h2 id="编译和使用" style="position:relative;"><a href="#%E7%BC%96%E8%AF%91%E5%92%8C%E4%BD%BF%E7%94%A8" aria-label="编译和使用 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>编译和使用</h2>
<h3 id="生成-js-和-wasm-文件" style="position:relative;"><a href="#%E7%94%9F%E6%88%90-js-%E5%92%8C-wasm-%E6%96%87%E4%BB%B6" aria-label="生成 js 和 wasm 文件 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>生成 JS 和 WASM 文件</h3>
<div class="gatsby-highlight" data-language="makefile"><pre class="language-makefile"><code class="language-makefile"><span class="token symbol">dist/vidy-standalone.js</span><span class="token punctuation">:</span>
    emcc transcoder/web.c transcoder/process.c \
                lib/ffmpeg/libavformat/libavformat.a \
                lib/ffmpeg/libavcodec/libavcodec.a \
                lib/ffmpeg/libswscale/libswscale.a \
                lib/ffmpeg/libavutil/libavutil.a \
                -s TOTAL_MEMORY<span class="token operator">=</span>33554432 \
                -s MODULARIZE<span class="token operator">=</span>1 \
                -O1 -s WASM<span class="token operator">=</span>1 -s EXTRA_EXPORTED_RUNTIME_METHODS<span class="token operator">=</span><span class="token string">'["ccall", "cwrap"]'</span> -s ALLOW_MEMORY_GROWTH<span class="token operator">=</span>1  \
                -Ilib/ffmpeg \
                --post-js transcoder/js/post.js \
                -o dist/vidy-standalone.js</code></pre></div>
<p>使用 <code>emcc</code> 编译：</p>
<ul>
<li>存放暴露给浏览器的相关接口的 <code>web.c</code></li>
<li>存放通用的 ffmpeg 方法调用的 <code>process.c</code> </li>
<li>以及之前生成个几个静态库文件 <code>.a</code></li>
</ul>
<p>其中一些参数说明一下：</p>
<ul>
<li><code>-s MODULARIZE=1</code> 让 emcc 生成模块工厂函数（而且还是 UMD 格式的），留待之后调用。否则默认情况下生成的 JS 会立刻执行，而且还会污染其所在全局环境（例如添加一个 self.Module 对象）</li>
</ul>
<p>一起生成目标文件 <code>dist/vidy-standalone.js</code>，由于传递了 <code>-s WASM=1</code>，还会生成同名的 <code>dist/vidy-standalone.wasm</code> 文件。JS 是一个一千来行的胶水代码，负责 WASM 模块的初始化和调用适配。WASM 文件大概 4.7M。</p>
<p>查看 <a href="%5Bhttps://emscripten.org/docs/tools_reference/emcc.html">emcc 文档</a> 和 <a href="https://github.com/emscripten-core/emscripten/blob/master/src/settings.js">关于 <code>-s</code> 的全部可选 setting</a>。</p>
<h3 id="使用方法" style="position:relative;"><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95" aria-label="使用方法 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>使用方法</h3>
<h4 id="简单的例子" style="position:relative;"><a href="#%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90" aria-label="简单的例子 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>简单的例子</h4>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> Module <span class="token keyword">from</span> <span class="token string">'../dist/vidy-standalone'</span>

<span class="token keyword">let</span> vidyModule

<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'//path/to/dist/vidy-standalone.wasm'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">arrayBuffer</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        vidyModule <span class="token operator">=</span> <span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            wasmBinary<span class="token operator">:</span> arrayBuffer
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">decodeVideoFrameImage</span><span class="token punctuation">(</span><span class="token string">'some.mp4'</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">decodeVideoFrameImage</span><span class="token punctuation">(</span><span class="token parameter">videoPath<span class="token punctuation">,</span> timeStamp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span>videoPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">videoBuffer</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> imageResult <span class="token operator">=</span> vidyModule<span class="token punctuation">.</span><span class="token function">getImage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>result<span class="token punctuation">,</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>timeStamp<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h4 id="稍微复杂点的例子" style="position:relative;"><a href="#%E7%A8%8D%E5%BE%AE%E5%A4%8D%E6%9D%82%E7%82%B9%E7%9A%84%E4%BE%8B%E5%AD%90" aria-label="稍微复杂点的例子 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>稍微复杂点的例子</h4>
<p>为了将模块更好地整合到前端工程中，有必要考虑在使用 webpack 的情况下如何引入。</p>
<p>参考 <a href="https://github.com/GoogleChromeLabs/squoosh/">GoogleChromeLabs/squoosh</a> 项目中的一些经验，首先看下 webpack 配置。webpack 团队在 v4 以后做了很多努力，想要让 WASM 模块的引入和使用与 js 文件一样方便，但实际实用中有很多边边角角 <a href="https://github.com/webpack/webpack/issues/6725">奇怪的问题和报错</a>，而且处理一个好几兆的 wasm 文件拖慢 webpack 冷启动许多，我们可以用一下配置让 webpack 不去读取 WASM 文件。使用 file-loader 也可以简单地配置带哈希的文件名，比起在项目中硬编码 WASM 文件路径，少去一些缓存问题。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// webpack config</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token operator">...</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.wasm$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token comment">// This is needed to make webpack NOT process wasm files.</span>
        type<span class="token operator">:</span> <span class="token string">'javascript/auto'</span><span class="token punctuation">,</span>
        loader<span class="token operator">:</span> <span class="token string">'file-loader'</span><span class="token punctuation">,</span>
        options<span class="token operator">:</span> <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'[name].[hash:5].[ext]'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
    <span class="token punctuation">]</span></code></pre></div>
<p>跟上面简单例子里效果相似的写法可以变成这样:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> Module <span class="token keyword">from</span> <span class="token string">'../dist/vidy-standalone'</span>
<span class="token keyword">import</span> vidyWasmUrl <span class="token keyword">from</span> <span class="token string">'../dist/vidy-standalone.wasm'</span> <span class="token comment">// 会被 file-loader 处理成一个静态文件的 url</span>

<span class="token keyword">const</span> vidyModule <span class="token operator">=</span> <span class="token function">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">locateFile</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Redirect the request for the wasm binary to whatever webpack gave us.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.wasm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> vidyWasmUrl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>emcc 生成的胶水代码里，默认请求的 WASM 文件路径是 <code>vidy-standalone.wasm</code>，但看看 <a href="https://github.com/emscripten-core/emscripten/blob/master/emcc.py#L2800">emcc 这一部分实现</a> 知道，如果给模块工厂函数 Module 传递了 <code>locateFile</code> 函数，就可以改写其内部会去请求的 WASM 文件路径。使用模块工厂函数的话，也不用自己去调用 <code>fetch</code> 了。</p>
<h2 id="一些具体实现的代码" style="position:relative;"><a href="#%E4%B8%80%E4%BA%9B%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E7%9A%84%E4%BB%A3%E7%A0%81" aria-label="一些具体实现的代码 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一些具体实现的代码</h2>
<p>首先看看 <code>web.c</code> 里暴露出的方法签名： </p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">EMSCRIPTEN_KEEPALIVE MyImageData <span class="token operator">*</span><span class="token function">seek_video_to</span><span class="token punctuation">(</span>uint8_t <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> buff_length<span class="token punctuation">,</span> <span class="token keyword">float</span> time_stamp<span class="token punctuation">)</span></code></pre></div>
<p>buffer 数组头指针 <code>buff</code>，buffer 长度 <code>buff_length</code>，以及用单精度浮点数表示的需要提取图像的时间。返回数据为我们自定义的结构。</p>
<h3 id="js-将视频数据写入-wasm-线性内存" style="position:relative;"><a href="#js-%E5%B0%86%E8%A7%86%E9%A2%91%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5-wasm-%E7%BA%BF%E6%80%A7%E5%86%85%E5%AD%98" aria-label="js 将视频数据写入 wasm 线性内存 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>[JS] 将视频数据写入 WASM 线性内存</h3>
<p>在 <code>post.js</code> 里，添加的一部分代码。</p>
<ul>
<li>根据 C 的方法签名，使用 emscripten 的胶水代码工具函数 <code>Module.cwrap</code> 包装一个 JS 的调用方法</li>
<li>给 emscripten 模块加上了 <code>Module.getImage</code> 方法，供外部调用</li>
</ul>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> seek_video_to <span class="token operator">=</span> <span class="token keyword">null</span>

Module<span class="token punctuation">.</span><span class="token function-variable function">onRuntimeInitialized</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  seek_video_to <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">cwrap</span><span class="token punctuation">(</span><span class="token string">'seek_video_to'</span><span class="token punctuation">,</span> <span class="token string">'number'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'number'</span><span class="token punctuation">,</span> <span class="token string">'number'</span><span class="token punctuation">,</span> <span class="token string">'number'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Module<span class="token punctuation">.</span><span class="token function-variable function">getImage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">buffer<span class="token punctuation">,</span> timeStamp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>seek_video_to<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> errcode<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> ptr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> before <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> data_arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    offset <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_malloc</span><span class="token punctuation">(</span>data_arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Module<span class="token punctuation">.</span><span class="token constant">HEAP8</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>data_arr<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ptr <span class="token operator">=</span> <span class="token function">seek_video_to</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> data_arr<span class="token punctuation">.</span>length<span class="token punctuation">,</span> timeStamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'seek_video_to costs'</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> before<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span></code></pre></div>
<h3 id="c-程序头部" style="position:relative;"><a href="#c-%E7%A8%8B%E5%BA%8F%E5%A4%B4%E9%83%A8" aria-label="c 程序头部 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>[C] 程序头部</h3>
<p>首先声明一些方便数据读取的全局变量:</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    uint8_t <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    size_t size<span class="token punctuation">;</span>
<span class="token punctuation">}</span> BufferData<span class="token punctuation">;</span>

<span class="token comment">/**
 * some global variables
 */</span>
BufferData global_buffer_data<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    uint32_t width<span class="token punctuation">;</span>
    uint32_t height<span class="token punctuation">;</span>
    uint8_t <span class="token operator">*</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span> MyImageData<span class="token punctuation">;</span></code></pre></div>
<p>全局变量 <code>global_buffer_data</code> 留作存放原始视频数据的结构，它所在的内存区域会被 JS 直接写入。</p>
<h3 id="c-avcodec-解析视频文件" style="position:relative;"><a href="#c-avcodec-%E8%A7%A3%E6%9E%90%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6" aria-label="c avcodec 解析视频文件 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>[C] avcodec 解析视频文件</h3>
<p>我们需要让 ffmpeg 能够从内存（而不是文件）中读取视频数据。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>avio_ctx_buffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">// 对于普通的mp4文件，这个size只要1MB就够了，但是对于mov/m4v需要和buff一样大</span>
    size_t avio_ctx_buffer_size <span class="token operator">=</span> buff_length<span class="token punctuation">;</span>

    global_buffer_data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> buff<span class="token punctuation">;</span>         <span class="token comment">/* will be grown as needed by the realloc above */</span>
    global_buffer_data<span class="token punctuation">.</span>size <span class="token operator">=</span> buff_length<span class="token punctuation">;</span> <span class="token comment">/* no data at this point */</span>

    AVFormatContext <span class="token operator">*</span>pFormatCtx <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    uint8_t <span class="token operator">*</span>avio_ctx_buffer <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">av_malloc</span><span class="token punctuation">(</span>avio_ctx_buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 读内存数据 */</span>
    AVIOContext <span class="token operator">*</span>avio_ctx <span class="token operator">=</span> <span class="token function">avio_alloc_context</span><span class="token punctuation">(</span>avio_ctx_buffer<span class="token punctuation">,</span> avio_ctx_buffer_size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> read_packet<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pFormatCtx<span class="token operator">-></span>pb <span class="token operator">=</span> avio_ctx<span class="token punctuation">;</span>
    pFormatCtx<span class="token operator">-></span>flags <span class="token operator">=</span> AVFMT_FLAG_CUSTOM_IO<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre></div>
<p>新建 <code>AVIOContext *avio_ctx</code>，指定目标 buffer 指针，目标 buffer 大小，以及我们提供的读取数据的 <code>read_packet</code> 函数，该 iocontext 需要读下一段数据时， <code>read_packet</code> 函数就将 <code>global_buffer_data</code> 中指定大小的数据写入目标 <code>*buf</code> 位置</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">read_packet</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>opaque<span class="token punctuation">,</span> uint8_t <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> buf_size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    buf_size <span class="token operator">=</span> <span class="token function">FFMIN</span><span class="token punctuation">(</span>buf_size<span class="token punctuation">,</span> global_buffer_data<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* copy internal buffer data to buf */</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> global_buffer_data<span class="token punctuation">.</span>ptr<span class="token punctuation">,</span> buf_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    global_buffer_data<span class="token punctuation">.</span>ptr <span class="token operator">+=</span> buf_size<span class="token punctuation">;</span>
    global_buffer_data<span class="token punctuation">.</span>size <span class="token operator">-=</span> buf_size<span class="token punctuation">;</span>

    <span class="token keyword">return</span> buf_size<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<h3 id="c-获取图片-rgb-数据" style="position:relative;"><a href="#c-%E8%8E%B7%E5%8F%96%E5%9B%BE%E7%89%87-rgb-%E6%95%B0%E6%8D%AE" aria-label="c 获取图片 rgb 数据 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>[C] 获取图片 rgb 数据</h3>
<p>这里内容太多，主要涉及 FFMpeg 的接口和视频编解码的知识，准备另写一篇。</p>
<h3 id="c-将图像等数据写入内存" style="position:relative;"><a href="#c-%E5%B0%86%E5%9B%BE%E5%83%8F%E7%AD%89%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98" aria-label="c 将图像等数据写入内存 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>[C] 将图像等数据写入内存</h3>
<p>当拿到包含 RGB 格式图像数据的 <code>AVFrame *pFrameRGB</code> 后，是时候将其中的颜色信息取出，转化为线性存储的，利于 JS 中 Canvas 元素使用的数据格式。</p>
<div class="gatsby-highlight" data-language="c"><pre class="language-c"><code class="language-c">uint8_t <span class="token operator">*</span><span class="token function">get_image_frame_buffer</span><span class="token punctuation">(</span>AVFrame <span class="token operator">*</span>pFrame<span class="token punctuation">,</span> AVCodecContext <span class="token operator">*</span>pCodecCtx<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> width <span class="token operator">=</span> pCodecCtx<span class="token operator">-></span>width<span class="token punctuation">;</span>
    <span class="token keyword">int</span> height <span class="token operator">=</span> pCodecCtx<span class="token operator">-></span>height<span class="token punctuation">;</span>

    <span class="token keyword">int</span> buffer_size <span class="token operator">=</span> height <span class="token operator">*</span> width <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>

    uint8_t <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>buffer_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Write pixel data</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> height<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>buffer <span class="token operator">+</span> y <span class="token operator">*</span> pFrame<span class="token operator">-></span>linesize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pFrame<span class="token operator">-></span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> y <span class="token operator">*</span> pFrame<span class="token operator">-></span>linesize<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> width <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>此函数返回的 <code>buffer</code> 指针指向的内存区域，会按照 <code>rgbrgb...</code> 的顺序存储图像颜色数据。每个像素需要 3 个存储单元，所以整个的 <code>buffer_size</code> 会是 <code>height * width * 3</code>。</p>
<p>接下来我们回到 JS 端。</p>
<h3 id="js-根据指针读出数据，构建-imagedata" style="position:relative;"><a href="#js-%E6%A0%B9%E6%8D%AE%E6%8C%87%E9%92%88%E8%AF%BB%E5%87%BA%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%9E%84%E5%BB%BA-imagedata" aria-label="js 根据指针读出数据，构建 imagedata permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>[JS] 根据指针读出数据，构建 ImageData</h3>
<p>WASM 返回的只是一个内存偏移量，此时我们手上有整个 WASM 实例的内存区域，得想办法把有用的数据读取出来。</p>
<p>首先我们知道 <code>MyImageData</code> 结构体宽和高都是用 <code>uint32_t</code>，紧接着存放颜色信息的数组单元类型为 <code>uint8_t</code>。</p>
<p>Emscripten 的胶水代码有提供 HEAPU (8/16/32/64) 几种步长的 dataviewer，可以按照以下方法读出数字和颜色数组。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// ...</span>
  <span class="token keyword">let</span> heap32Start <span class="token operator">=</span> ptr <span class="token operator">/</span> <span class="token number">4</span>
  <span class="token keyword">let</span> width <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token constant">HEAPU32</span><span class="token punctuation">[</span>heap32Start<span class="token punctuation">]</span>
  <span class="token keyword">let</span> height <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token constant">HEAPU32</span><span class="token punctuation">[</span>heap32Start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    imgBufferPtr <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token constant">HEAPU32</span><span class="token punctuation">[</span>heap32Start <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    imageBuffer <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token constant">HEAP</span><span class="token punctuation">.</span><span class="token function">subarray</span><span class="token punctuation">(</span>imgBufferPtr<span class="token punctuation">,</span> imgBufferPtr <span class="token operator">+</span> width <span class="token operator">*</span> height <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> imageInfo <span class="token operator">=</span> <span class="token punctuation">{</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> imageDataArr<span class="token operator">:</span> imageBuffer <span class="token punctuation">}</span>
  <span class="token keyword">let</span> imageData <span class="token operator">=</span> <span class="token function">imageInfoToImageData</span><span class="token punctuation">(</span>imageInfo<span class="token punctuation">)</span>
<span class="token comment">// ...</span>

<span class="token keyword">function</span> <span class="token function">imageInfoToImageData</span><span class="token punctuation">(</span>imageInfo<span class="token operator">:</span> VidyImageInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> imageDataArr <span class="token punctuation">}</span> <span class="token operator">=</span> imageInfo
  <span class="token keyword">const</span> imageData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageData</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
  <span class="token comment">// 目前只返回 RGB24 格式的数据, 不处理透明度</span>
  <span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imageDataArr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;&amp;</span> i <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      imageData<span class="token punctuation">.</span>data<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">255</span>
    <span class="token punctuation">}</span>
    imageData<span class="token punctuation">.</span>data<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> imageDataArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  imageData<span class="token punctuation">.</span>data<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">255</span>
  <span class="token keyword">return</span> imageData
<span class="token punctuation">}</span></code></pre></div>
<p>绘制到 canvas 上就很简单了</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> width
canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> height
<span class="token keyword">let</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span>
ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>imageData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></code></pre></div>
<h2 id="总结" style="position:relative;"><a href="#%E6%80%BB%E7%BB%93" aria-label="总结 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结</h2>
<p>跟着别人的文章思路，小小修改，跑通了一个 demo，大致熟悉一下 C 项目使用 Emscripten 转化为前端可用模块的方案。</p>
<p>不是很熟悉 C 语言，同时在 JS 和 C 端手动管理内存虽然对于入门者来说很容易操作，但稍显繁琐。</p>
<p>Emscripten 多用于翻译现有的 C/C++ 库代码，对于 Web API 和前端生态的支持，明显没有隔壁 Mozilla 的 Rust 社区积极。不过音视频技术实现，的确是 C 的传统强项领域，若想少造轮子，还是要好好学习的。</p>
<h2 id="参考" style="position:relative;"><a href="#%E5%8F%82%E8%80%83" aria-label="参考 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参考</h2>
<p> <a href="https://zhuanlan.zhihu.com/p/40786748">https://zhuanlan.zhihu.com/p/40786748</a> </p></div><div class="navigation-module--navigation--3Zfju"><span class="navigation-module--button--28kp3"><a href="/2019-03-13-Handy-Video-Analyze-Tool/"><span class="navigation-module--iconPrev--23mg1">←</span><span class="navigation-module--buttonText--1Xod2">Handy Video Analyze Tool</span></a></span><span class="navigation-module--button--28kp3"><a href="/2019-02-14-Setup-CI-in-docker/"><span class="navigation-module--buttonText--1Xod2">在 docker 环境中从 gitlab 拉取源码</span><span class="navigation-module--iconNext--3xyJ-">→</span></a></span></div></div></div></div><footer><span class="footerCopyrights">© 2020 Built with <a href="https://www.gatsbyjs.org">Gatsby</a></span><span class="footerCopyrights">Created by <a href="https://hikerpig.github.io/">hikerpig</a></span></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='UA-49433257-1',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.defer=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-49433257-1', 'auto', {});
      ga('set', 'anonymizeIp', true);
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2019-03-06-Decode-Video-Using-FFMpeg-In-Browser/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-d7c43275abf3c296b887.js"],"app":["/app-1d0336bfb45b291984c0.js"],"component---src-pages-404-js":["/component---src-pages-404-js-376099c4d78d653dd7fc.js"],"component---src-templates-archives-js":["/component---src-templates-archives-js-b9dcceb7682b5cdc4de7.js"],"component---src-templates-index-js":["/component---src-templates-index-js-7a8e56b386614684fac8.js"],"component---src-templates-page-js":["/component---src-templates-page-js-77b515186c30c4b9f999.js"],"component---src-templates-tags-js":["/component---src-templates-tags-js-f11478861c5abb31741c.js"]};/*]]>*/</script><script src="/polyfill-d7c43275abf3c296b887.js" nomodule=""></script><script src="/component---src-templates-page-js-77b515186c30c4b9f999.js" async=""></script><script src="/23c3d3a3a2879427593569aafa02d04d4d5b9e2a-dcd5761da3e45fbc9bc8.js" async=""></script><script src="/commons-54da21bc01fa6cc2b833.js" async=""></script><script src="/styles-407fe62976dc5310c43e.js" async=""></script><script src="/app-1d0336bfb45b291984c0.js" async=""></script><script src="/framework-fc9659a3b74fac5c7369.js" async=""></script><script src="/webpack-runtime-b89597f0e82278f0e44d.js" async=""></script></body></html>